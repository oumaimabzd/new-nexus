<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FYRTORN v6 | Incident Documentation for Schools</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #386c70;
        --primary-dark: #244547;
        --primary-light: #4a8a8f;
        --accent-yellow: #d6c574;
        --accent-orange: #d6634a;
        --bg: #f8f9fa;
        --white: #ffffff;
        --text: #2d3748;
        --text-light: #718096;
        --border: #e2e8f0;
        --success: #48bb78;
        --warning: #ed8936;
        --error: #e53e3e;
        --info: #4299e1;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
        --radius: 10px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        line-height: 1.6;
      }

      /* === HEADER === */
      .header {
        background: var(--white);
        border-bottom: 1px solid var(--border);
        padding: 0.75rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        cursor: pointer;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: var(--primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
      }

      .logo-text {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-dark);
        letter-spacing: 0.5px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .role-select {
        padding: 0.4rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family: inherit;
        font-size: 0.8rem;
        background: var(--white);
        cursor: pointer;
      }

      .user-name {
        font-size: 0.85rem;
        font-weight: 500;
      }

      /* === MAIN === */
      .main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      /* === BUTTONS === */
      .btn {
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-secondary {
        background: var(--white);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .btn-ghost {
        background: none;
        color: var(--text-light);
        padding: 0.4rem 0.75rem;
      }

      .btn-ghost:hover {
        color: var(--text);
        background: var(--bg);
      }

      .btn-sm {
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
      }

      .btn-lg {
        padding: 1rem 2rem;
        font-size: 1rem;
      }

      /* === DASHBOARD === */
      .dashboard-header {
        margin-bottom: 1.5rem;
      }

      .greeting {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .greeting-sub {
        color: var(--text-light);
        font-size: 0.9rem;
      }

      .alert-banner {
        background: #fff5f5;
        border: 1px solid #feb2b2;
        border-radius: var(--radius);
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .alert-banner.warning {
        background: #fffaf0;
        border-color: #fbd38d;
      }

      .alert-banner.hidden {
        display: none;
      }

      .alert-icon {
        font-size: 1.5rem;
      }

      .alert-content {
        flex: 1;
      }

      .alert-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #c53030;
      }

      .alert-banner.warning .alert-title {
        color: #c05621;
      }

      .alert-text {
        font-size: 0.8rem;
        color: #742a2a;
      }

      .alert-banner.warning .alert-text {
        color: #7b341e;
      }

      .alert-btn {
        padding: 0.5rem 1rem;
        background: #c53030;
        color: white;
        border: none;
        border-radius: 6px;
        font-family: inherit;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
      }

      .alert-banner.warning .alert-btn {
        background: #dd6b20;
      }

      .big-action {
        background: var(--primary);
        color: white;
        border-radius: var(--radius);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1.5rem;
      }

      .big-action:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .big-action-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .big-action-title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .big-action-desc {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-top: 0.25rem;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .section-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .see-all {
        font-size: 0.8rem;
        color: var(--primary);
        cursor: pointer;
      }

      .see-all:hover {
        text-decoration: underline;
      }

      /* === CARDS === */
      .card {
        background: var(--white);
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-body {
        padding: 1.25rem;
      }

      /* === INCIDENT LIST === */
      .incident-list {
        background: var(--white);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .incident-item {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        transition: background 0.15s;
      }

      .incident-item:last-child {
        border-bottom: none;
      }
      .incident-item:hover {
        background: var(--bg);
      }

      .incident-item.urgent {
        background: #fff5f5;
        border-left: 3px solid var(--error);
      }

      .incident-item.flagged {
        background: #fffaf0;
        border-left: 3px solid var(--warning);
      }

      .severity-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .severity-dot.critical {
        background: var(--error);
      }
      .severity-dot.serious {
        background: var(--warning);
      }
      .severity-dot.moderate {
        background: #ecc94b;
      }
      .severity-dot.minor {
        background: var(--success);
      }

      .incident-info {
        flex: 1;
        min-width: 0;
      }

      .incident-title {
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .incident-meta {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.2rem;
      }

      .badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-open {
        background: #fef3c7;
        color: #92400e;
      }
      .badge-progress {
        background: #dbeafe;
        color: #1e40af;
      }
      .badge-action {
        background: #e9d5ff;
        color: #6b21a8;
      }
      .badge-closed {
        background: #e2e8f0;
        color: #475569;
      }
      .badge-legal {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge-threshold {
        background: #fed7aa;
        color: #9a3412;
      }

      .status-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-weight: 500;
        flex-shrink: 0;
      }

      .status-open {
        background: #fef3c7;
        color: #92400e;
      }
      .status-progress {
        background: #dbeafe;
        color: #1e40af;
      }
      .status-action {
        background: #e9d5ff;
        color: #6b21a8;
      }
      .status-followup {
        background: #d1fae5;
        color: #065f46;
      }
      .status-closed {
        background: #e2e8f0;
        color: #475569;
      }

      /* === QUICK LINKS === */
      .quick-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .quick-link {
        background: var(--white);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
      }

      .quick-link:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow);
      }

      .quick-link-icon {
        font-size: 1.5rem;
        margin-bottom: 0.4rem;
      }

      .quick-link-text {
        font-size: 0.75rem;
        font-weight: 500;
      }

      /* === FILTERS === */
      .filters {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .search-box {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 0.6rem 1rem 0.6rem 2.5rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.85rem;
        background: var(--white)
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23718096'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3E%3C/path%3E%3C/svg%3E")
          no-repeat 0.75rem center;
        background-size: 18px;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .filter-select {
        padding: 0.6rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.8rem;
        background: var(--white);
        cursor: pointer;
        min-width: 140px;
      }

      .filter-select:focus {
        outline: none;
        border-color: var(--primary);
      }

      /* === WIZARD FORM === */
      .wizard {
        background: var(--white);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .wizard-progress {
        display: flex;
        border-bottom: 1px solid var(--border);
        background: var(--bg);
      }

      .wizard-step {
        flex: 1;
        padding: 1rem;
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-light);
        position: relative;
      }

      .wizard-step.active {
        background: var(--white);
        color: var(--primary);
        font-weight: 600;
      }

      .wizard-step.completed {
        color: var(--success);
      }

      .wizard-step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--border);
        color: var(--text-light);
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.5rem;
      }

      .wizard-step.active .wizard-step-number {
        background: var(--primary);
        color: white;
      }

      .wizard-step.completed .wizard-step-number {
        background: var(--success);
        color: white;
      }

      .wizard-content {
        padding: 2rem;
        min-height: 350px;
      }

      .wizard-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .wizard-desc {
        color: var(--text-light);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .wizard-footer {
        padding: 1rem 2rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        background: var(--bg);
      }

      /* === FORM ELEMENTS === */
      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 0.4rem;
      }

      .form-label .required {
        color: var(--error);
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.9rem;
        transition: border-color 0.2s;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(56, 108, 112, 0.1);
      }

      .form-textarea {
        min-height: 100px;
        resize: vertical;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .form-help {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.3rem;
      }

      /* === CATEGORY GRID === */
      .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.75rem;
      }

      .category-card {
        border: 2px solid var(--border);
        border-radius: 10px;
        padding: 1rem 0.75rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .category-card:hover {
        border-color: var(--primary-light);
        background: rgba(56, 108, 112, 0.02);
      }

      .category-card.selected {
        border-color: var(--primary);
        background: rgba(56, 108, 112, 0.05);
      }

      .category-card-icon {
        font-size: 1.75rem;
        margin-bottom: 0.4rem;
      }

      .category-card-name {
        font-size: 0.75rem;
        font-weight: 500;
        line-height: 1.3;
      }

      /* === SUBCATEGORY TAGS === */
      .subcategory-section {
        margin-top: 1.5rem;
        padding: 1.25rem;
        background: var(--bg);
        border-radius: 8px;
        display: none;
      }

      .subcategory-section.active {
        display: block;
      }

      .subcategory-label {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
      }

      .subcategory-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .subcat-tag {
        padding: 0.5rem 1rem;
        background: var(--white);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .subcat-tag:hover {
        border-color: var(--primary);
      }

      .subcat-tag.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* === GUIDANCE BOX === */
      .guidance-box {
        margin-top: 1.25rem;
        padding: 1rem 1.25rem;
        border-radius: 8px;
        border-left: 4px solid var(--info);
        background: #ebf8ff;
      }

      .guidance-box.warning {
        background: #fffaf0;
        border-color: var(--warning);
      }

      .guidance-box.alert {
        background: #fff5f5;
        border-color: var(--error);
      }

      .guidance-title {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.4rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .guidance-box.alert .guidance-title {
        color: #c53030;
      }
      .guidance-box.warning .guidance-title {
        color: #c05621;
      }

      .guidance-text {
        font-size: 0.85rem;
        line-height: 1.6;
      }

      .guidance-links {
        margin-top: 0.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .guidance-link {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.75rem;
        color: var(--primary);
        text-decoration: none;
        padding: 0.3rem 0.6rem;
        background: rgba(56, 108, 112, 0.1);
        border-radius: 4px;
      }

      .guidance-link:hover {
        background: var(--primary);
        color: white;
      }

      /* === SEVERITY OPTIONS === */
      .severity-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
      }

      .severity-card {
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .severity-card:hover {
        border-color: var(--primary-light);
      }

      .severity-card.selected {
        border-color: var(--primary);
        background: rgba(56, 108, 112, 0.05);
      }

      .severity-card-label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .severity-card-desc {
        font-size: 0.7rem;
        color: var(--text-light);
      }

      .severity-card.minor .severity-card-label {
        color: var(--success);
      }
      .severity-card.moderate .severity-card-label {
        color: #d69e2e;
      }
      .severity-card.serious .severity-card-label {
        color: var(--warning);
      }
      .severity-card.critical .severity-card-label {
        color: var(--error);
      }

      /* === DETAIL PAGE === */
      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 1.5rem;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        color: var(--text-light);
        font-size: 0.85rem;
        cursor: pointer;
        margin-bottom: 1rem;
      }

      .back-link:hover {
        color: var(--primary);
      }

      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
      }

      .detail-title {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .detail-subtitle {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-top: 0.25rem;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .info-label {
        color: var(--text-light);
        font-size: 0.85rem;
      }

      .info-value {
        font-weight: 500;
      }

      /* === ACTION TOOLBOX === */
      .action-toolbox {
        list-style: none;
      }

      .action-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.6rem 0;
        border-bottom: 1px solid var(--border);
      }

      .action-item:last-child {
        border-bottom: none;
      }

      .action-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 2px;
        font-size: 0.7rem;
        color: transparent;
        transition: all 0.2s;
      }

      .action-checkbox:hover {
        border-color: var(--primary);
      }

      .action-checkbox.checked {
        background: var(--success);
        border-color: var(--success);
        color: white;
      }

      .action-content {
        flex: 1;
      }

      .action-name {
        font-size: 0.85rem;
        font-weight: 500;
      }

      .action-date {
        font-size: 0.7rem;
        color: var(--text-light);
      }

      .add-action-btn {
        width: 100%;
        padding: 0.6rem;
        border: 1px dashed var(--border);
        background: transparent;
        border-radius: 6px;
        font-family: inherit;
        font-size: 0.8rem;
        color: var(--text-light);
        cursor: pointer;
        margin-top: 0.75rem;
        transition: all 0.2s;
      }

      .add-action-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(56, 108, 112, 0.02);
      }

      /* === TIMELINE === */
      .timeline {
        list-style: none;
      }

      .timeline-item {
        position: relative;
        padding-left: 1.5rem;
        padding-bottom: 0.75rem;
        border-left: 2px solid var(--border);
        margin-left: 0.5rem;
      }

      .timeline-item:last-child {
        border-left-color: transparent;
        padding-bottom: 0;
      }

      .timeline-item::before {
        content: "";
        position: absolute;
        left: -5px;
        top: 3px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary);
      }

      .timeline-date {
        font-size: 0.65rem;
        color: var(--text-light);
        margin-bottom: 0.15rem;
      }

      .timeline-text {
        font-size: 0.8rem;
      }

      .timeline-user {
        font-size: 0.7rem;
        color: var(--text-light);
      }

      /* === LEGAL BOX === */
      .legal-box {
        background: #fff5f5;
        border: 1px solid #feb2b2;
        border-radius: 8px;
        padding: 1rem;
      }

      .legal-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--error);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .legal-item {
        display: flex;
        align-items: flex-start;
        gap: 0.6rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(254, 178, 178, 0.5);
        font-size: 0.8rem;
      }

      .legal-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      /* === ADMIN === */
      .admin-table {
        width: 100%;
        border-collapse: collapse;
      }

      .admin-table th,
      .admin-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
        font-size: 0.85rem;
      }

      .admin-table th {
        background: var(--bg);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-light);
      }

      .admin-table tr:hover td {
        background: var(--bg);
      }

      .role-tag {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .role-tag.teacher {
        background: #dbeafe;
        color: #1e40af;
      }
      .role-tag.mentor {
        background: #d1fae5;
        color: #065f46;
      }
      .role-tag.headofyear {
        background: #fef3c7;
        color: #92400e;
      }
      .role-tag.counselor {
        background: #e9d5ff;
        color: #6b21a8;
      }
      .role-tag.principal {
        background: #fee2e2;
        color: #991b1b;
      }
      .role-tag.admin {
        background: #374151;
        color: white;
      }

      .access-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
      }

      .access-tag {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        background: var(--bg);
        border-radius: 3px;
        color: var(--text-light);
      }

      /* === MODAL === */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1.5rem;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--white);
        border-radius: 12px;
        max-width: 480px;
        width: 100%;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal.wide {
        max-width: 600px;
      }

      .modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 1rem;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-light);
        cursor: pointer;
        line-height: 1;
      }

      .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      }

      /* === SUCCESS === */
      .success-page {
        text-align: center;
        padding: 3rem 2rem;
      }

      .success-icon {
        width: 80px;
        height: 80px;
        background: #c6f6d5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 1.5rem;
      }

      .success-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .success-text {
        color: var(--text-light);
        margin-bottom: 2rem;
      }

      .success-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      /* === TOAST === */
      .toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 2000;
      }

      .toast {
        background: var(--text);
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        margin-top: 0.5rem;
        animation: slideIn 0.3s ease;
        font-size: 0.85rem;
        box-shadow: var(--shadow-md);
      }

      .toast.success {
        background: var(--success);
      }
      .toast.error {
        background: var(--error);
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* === STATS === */
      .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-box {
        background: var(--white);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        text-align: center;
        transition: all 0.2s;
      }

      .stat-box:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .stat-label {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.2rem;
      }

      /* === WORKFLOW CHECKLIST === */
      .workflow-section {
        background: var(--white);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 1rem;
        overflow: hidden;
      }

      .workflow-header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .workflow-progress {
        font-size: 0.75rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
      }

      .workflow-body {
        padding: 1rem;
      }

      .workflow-step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
        border: 1px solid transparent;
      }

      .workflow-step:hover {
        background: #f7fafc;
        border-color: var(--border);
      }

      .workflow-step.completed {
        background: #f0fff4;
        border-color: #9ae6b4;
      }

      .workflow-step.planned {
        background: #fffaf0;
        border-color: #fbd38d;
      }

      .workflow-step.not-applicable {
        opacity: 0.5;
      }

      .step-checkbox {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        flex-shrink: 0;
        transition: all 0.2s;
      }

      .workflow-step.completed .step-checkbox {
        background: var(--success);
        border-color: var(--success);
        color: white;
      }

      .workflow-step.planned .step-checkbox {
        background: var(--warning);
        border-color: var(--warning);
        color: white;
      }

      .step-content {
        flex: 1;
      }

      .step-title {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text);
      }

      .step-meta {
        font-size: 0.7rem;
        color: var(--text-light);
        margin-top: 0.1rem;
      }

      .step-status {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
      }

      .step-status.done {
        background: #c6f6d5;
        color: #22543d;
      }

      .step-status.pending {
        background: #feebc8;
        color: #744210;
      }

      .step-status.waiting {
        background: #e2e8f0;
        color: #4a5568;
      }

      /* Action Checklist */
      .action-checklist {
        margin-top: 0.5rem;
      }

      .action-group {
        margin-bottom: 1rem;
      }

      .action-group-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        padding-bottom: 0.3rem;
        border-bottom: 1px solid var(--border);
      }

      .action-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.25rem;
        cursor: pointer;
        transition: all 0.15s;
      }

      .action-item:hover {
        background: #f7fafc;
      }

      .action-item.state-done {
        background: #f0fff4;
      }

      .action-item.state-planned {
        background: #fffaf0;
      }

      .action-item.state-na {
        opacity: 0.4;
      }

      .action-toggle {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        flex-shrink: 0;
        background: white;
      }

      .action-item.state-done .action-toggle {
        background: var(--success);
        border-color: var(--success);
        color: white;
      }

      .action-item.state-planned .action-toggle {
        background: var(--warning);
        border-color: var(--warning);
        color: white;
      }

      .action-label {
        flex: 1;
        font-size: 0.8rem;
      }

      .action-date {
        font-size: 0.65rem;
        color: var(--text-light);
      }

      .escalation-chain {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }

      .escalation-step {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .escalation-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background: #e2e8f0;
        color: var(--text);
      }

      .escalation-badge.active {
        background: var(--primary);
        color: white;
      }

      .escalation-badge.done {
        background: var(--success);
        color: white;
      }

      .escalation-arrow {
        color: var(--text-light);
        font-size: 0.7rem;
      }

      /* === RESPONSIVE === */
      @media (max-width: 900px) {
        .detail-grid {
          grid-template-columns: 1fr;
        }
        .stats-row {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 600px) {
        .main {
          padding: 1rem;
        }
        .wizard-content {
          padding: 1.5rem;
        }
        .category-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .severity-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .form-row {
          grid-template-columns: 1fr;
        }
        .filters {
          flex-direction: column;
        }
        .search-box {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="logo" onclick="showPage('dashboard')">
        <div class="logo-icon">üè´</div>
        <span class="logo-text">FYRTORN</span>
      </div>
      <div class="header-right">
        <select
          class="role-select"
          id="roleSelect"
          onchange="changeRole(this.value)"
        >
          <option value="teacher">Teacher</option>
          <option value="mentor">Mentor (8B)</option>
          <option value="headofyear">Head of Year (Grade 7)</option>
          <option value="counselor">Counselor</option>
          <option value="principal">Principal</option>
          <option value="admin">Administrator</option>
        </select>
        <span class="user-name">Maria Andersson</span>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <!-- ========== DASHBOARD ========== -->
      <div class="page active" id="page-dashboard">
        <div class="dashboard-header">
          <h1 class="greeting">Hello Maria!</h1>
          <p class="greeting-sub" id="dashboardSubtitle">
            You have 2 open cases
          </p>
        </div>

        <!-- Alerts -->
        <div class="alert-banner hidden" id="alertBanner">
          <span class="alert-icon">üö®</span>
          <div class="alert-content">
            <div class="alert-title">2 cases require immediate action</div>
            <div class="alert-text">
              Welfare report must be made within 24 hours
            </div>
          </div>
          <button class="alert-btn" onclick="filterByUrgent()">View</button>
        </div>

        <div class="alert-banner warning hidden" id="warningBanner">
          <span class="alert-icon">‚ö†Ô∏è</span>
          <div class="alert-content">
            <div class="alert-title">3 cases need follow-up</div>
            <div class="alert-text">Scheduled follow-up this week</div>
          </div>
          <button class="alert-btn" onclick="filterByFollowup()">View</button>
        </div>

        <div
          class="alert-banner info hidden"
          id="retentionBanner"
          style="background: #ebf8ff; border-color: #90cdf4"
        >
          <span class="alert-icon">üìã</span>
          <div class="alert-content">
            <div class="alert-title" style="color: #2b6cb0">
              5 cases approaching deletion date
            </div>
            <div class="alert-text" style="color: #2c5282">
              Review before automatic deletion
            </div>
          </div>
          <button
            class="alert-btn"
            style="background: #3182ce"
            onclick="
              showPage('admin');
              showAdminTab('gdpr');
            "
          >
            Review
          </button>
        </div>

        <!-- Big Action -->
        <div class="big-action" onclick="showPage('report')">
          <div class="big-action-icon">üìù</div>
          <div class="big-action-title">Document New Incident</div>
          <div class="big-action-desc">
            Record an event that needs documentation
          </div>
        </div>

        <!-- Stats (for principals) -->
        <div class="stats-row hidden" id="statsRow">
          <div
            class="stat-box"
            onclick="filterByMonth()"
            style="cursor: pointer"
          >
            <div class="stat-value">24</div>
            <div class="stat-label">This Month</div>
          </div>
          <div
            class="stat-box"
            onclick="filterByOpen()"
            style="cursor: pointer"
          >
            <div class="stat-value">8</div>
            <div class="stat-label">Open</div>
          </div>
          <div
            class="stat-box"
            onclick="filterByCritical()"
            style="cursor: pointer"
          >
            <div class="stat-value">3</div>
            <div class="stat-label">Critical</div>
          </div>
          <div
            class="stat-box"
            onclick="filterByClosed()"
            style="cursor: pointer"
          >
            <div class="stat-value">16</div>
            <div class="stat-label">Closed</div>
          </div>
        </div>

        <!-- MY TASKS - Task Reminder Section -->
        <div
          class="task-reminder-box"
          id="taskReminderBox"
          style="
            background: linear-gradient(135deg, #ebf8ff 0%, #fff 100%);
            border: 1px solid #90cdf4;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.75rem;
            "
          >
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <span style="font-size: 1.25rem">üîî</span>
              <span style="font-weight: 600; color: #2b6cb0; font-size: 0.95rem"
                >My Tasks</span
              >
            </div>
            <span
              class="task-count"
              style="
                background: #3182ce;
                color: white;
                padding: 0.2rem 0.6rem;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: 600;
              "
              id="taskCountBadge"
              >3 pending</span
            >
          </div>
          <div
            id="taskSummary"
            style="font-size: 0.85rem; color: #2c5282; margin-bottom: 0.75rem"
          >
            <span style="color: #c53030; font-weight: 500">1 due today</span> ‚Ä¢
            <span>2 due this week</span>
          </div>
          <div id="urgentTasksList" style="margin-bottom: 0.75rem">
            <div
              class="urgent-task"
              onclick="showIncident(2)"
              style="
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.5rem;
                background: white;
                border-radius: 6px;
                margin-bottom: 0.5rem;
                cursor: pointer;
                border-left: 3px solid #c53030;
              "
            >
              <span style="font-size: 0.8rem">‚è∞</span>
              <div style="flex: 1">
                <div
                  style="font-size: 0.8rem; font-weight: 500; color: #2d3748"
                >
                  Contact with guardians
                </div>
                <div style="font-size: 0.7rem; color: #718096">
                  INC-2025-0042 ‚Ä¢ Erik J. ‚Ä¢ Due today
                </div>
              </div>
            </div>
            <div
              class="urgent-task"
              onclick="showIncident(1)"
              style="
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.5rem;
                background: white;
                border-radius: 6px;
                margin-bottom: 0.5rem;
                cursor: pointer;
                border-left: 3px solid #dd6b20;
              "
            >
              <span style="font-size: 0.8rem">üìã</span>
              <div style="flex: 1">
                <div
                  style="font-size: 0.8rem; font-weight: 500; color: #2d3748"
                >
                  Follow-up with counselor
                </div>
                <div style="font-size: 0.7rem; color: #718096">
                  INC-2025-0041 ‚Ä¢ Oscar N. ‚Ä¢ Due tomorrow
                </div>
              </div>
            </div>
          </div>
          <button
            class="btn btn-ghost"
            onclick="showPage('tasks')"
            style="width: 100%; font-size: 0.85rem; padding: 0.5rem"
          >
            View all my tasks ‚Üí
          </button>
        </div>

        <!-- Recent Incidents -->
        <div class="section-header">
          <h2 class="section-title" id="incidentListTitle">My Cases</h2>
          <span class="see-all" onclick="showPage('list')">View all ‚Üí</span>
        </div>

        <div class="incident-list" id="dashboardIncidents">
          <!-- Filled by JS -->
        </div>

        <!-- Quick Links -->
        <div class="quick-links">
          <a
            href="https://polisen.se/utsatt-for-brott/polisanmalan/"
            target="_blank"
            class="quick-link"
          >
            <div class="quick-link-icon">üëÆ</div>
            <div class="quick-link-text">Police Report</div>
          </a>
          <a
            href="https://www.socialstyrelsen.se/"
            target="_blank"
            class="quick-link"
          >
            <div class="quick-link-icon">üèõÔ∏è</div>
            <div class="quick-link-text">Welfare Report</div>
          </a>
          <a
            href="https://www.skolverket.se/"
            target="_blank"
            class="quick-link"
          >
            <div class="quick-link-icon">üìö</div>
            <div class="quick-link-text">Education Agency</div>
          </a>
          <div class="quick-link" id="ehtLink" onclick="showPage('eht')">
            <div class="quick-link-icon">üè•</div>
            <div class="quick-link-text">EHT Meetings</div>
          </div>
          <div
            class="quick-link hidden"
            id="adminLink"
            onclick="showPage('admin')"
          >
            <div class="quick-link-icon">‚öôÔ∏è</div>
            <div class="quick-link-text">Administration</div>
          </div>
        </div>
      </div>

      <!-- ========== INCIDENT LIST ========== -->
      <div class="page" id="page-list">
        <span class="back-link" onclick="showPage('dashboard')">‚Üê Back</span>

        <div class="section-header">
          <h2 class="section-title" id="listPageTitle">All Cases</h2>
          <button class="btn btn-primary" onclick="showPage('report')">
            + Dokumentera incident
          </button>
        </div>

        <div class="filters">
          <div class="search-box">
            <input
              type="text"
              class="search-input"
              placeholder="Search student, klass..."
              id="searchInput"
              oninput="filterIncidents()"
            />
          </div>
          <select
            class="filter-select"
            id="categoryFilter"
            onchange="filterIncidents()"
          >
            <option value="">All kategorier</option>
            <option value="violence">üëä Violence & Threats</option>
            <option value="bullying">üò¢ Bullying & Harassment</option>
            <option value="disruption">üì¢ Disruption</option>
            <option value="absence">üö∂ Absence & skolk</option>
            <option value="substance">üö≠ Drugs & Tobacco</option>
            <option value="welfare">üíô Welfare Concern</option>
            <option value="theft">üîí Theft & Vandalism</option>
            <option value="digital">üì± Digital Incident</option>
            <option value="extremism">üè¥ Extremism</option>
            <option value="gang">üë• Gang Activity</option>
            <option value="other">‚ö†Ô∏è Other</option>
          </select>
          <select
            class="filter-select"
            id="statusFilter"
            onchange="filterIncidents()"
          >
            <option value="">All status</option>
            <option value="open">Open</option>
            <option value="progress">Under investigation</option>
            <option value="action">Action in progress</option>
            <option value="followup">Follow-up</option>
            <option value="closed">Closed</option>
          </select>
          <select
            class="filter-select"
            id="severityFilter"
            onchange="filterIncidents()"
          >
            <option value="">All levels</option>
            <option value="critical">Critical</option>
            <option value="serious">Serious</option>
            <option value="moderate">Moderate</option>
            <option value="minor">Minor</option>
          </select>
        </div>

        <div class="incident-list" id="fullIncidentList">
          <!-- Filled by JS -->
        </div>
      </div>

      <!-- ========== REPORT WIZARD ========== -->
      <div class="page" id="page-report">
        <span class="back-link" onclick="confirmExit()">‚Üê Cancel</span>

        <div class="wizard">
          <div class="wizard-progress">
            <div class="wizard-step active" id="step1-tab">
              <span class="wizard-step-number">1</span> Elev
            </div>
            <div class="wizard-step" id="step2-tab">
              <span class="wizard-step-number">2</span> Incident
            </div>
            <div class="wizard-step" id="step3-tab">
              <span class="wizard-step-number">3</span> Detaljer
            </div>
            <div class="wizard-step" id="step4-tab">
              <span class="wizard-step-number">4</span> Actions
            </div>
            <div class="wizard-step" id="step5-tab">
              <span class="wizard-step-number">5</span> Granska
            </div>
          </div>

          <!-- Step 1: Student -->
          <div class="wizard-content" id="step1">
            <h2 class="wizard-title">Who is involved?</h2>
            <p class="wizard-desc">Enter information about people involved</p>

            <!-- SECTION: Reported Student (involved) -->
            <div
              class="person-section"
              style="
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 0.75rem;
                "
              >
                <span style="font-weight: 600; color: var(--primary-dark)"
                  >üìã Reported Student <span class="required">*</span></span
                >
                <span style="font-size: 0.75rem; color: var(--text-light)"
                  >The student whose behavior is being reported</span
                >
              </div>
              <div id="reportedStudentsList">
                <div
                  class="person-entry"
                  data-role="reported"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 120px 40px;
                    gap: 0.5rem;
                    align-items: end;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div class="form-group" style="margin: 0">
                    <label class="form-label" style="font-size: 0.75rem"
                      >Name <span class="required">*</span></label
                    >
                    <input
                      type="text"
                      class="form-input person-name"
                      placeholder="First and last name"
                      id="inputStudentName"
                    />
                  </div>
                  <div class="form-group" style="margin: 0">
                    <label class="form-label" style="font-size: 0.75rem"
                      >Class <span class="required">*</span></label
                    >
                    <input
                      type="text"
                      class="form-input person-class"
                      placeholder="E.g. 8B"
                      id="inputClass"
                    />
                  </div>
                  <div></div>
                </div>
              </div>
              <button
                type="button"
                class="btn-add-person"
                onclick="addPerson('reportedStudentsList', 'reported')"
                style="
                  background: none;
                  border: 1px dashed var(--border);
                  border-radius: 6px;
                  padding: 0.5rem;
                  width: 100%;
                  color: var(--text-light);
                  cursor: pointer;
                  font-size: 0.8rem;
                "
              >
                + Add more reported students
              </button>
            </div>

            <!-- SECTION: Affected students/staff -->
            <div
              class="person-section"
              style="
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 0.75rem;
                "
              >
                <span style="font-weight: 600; color: var(--primary-dark)"
                  >üõ°Ô∏è Affected students/staff</span
                >
                <span style="font-size: 0.75rem; color: var(--text-light)"
                  >Victims or those affected by the incident</span
                >
              </div>
              <div id="affectedPersonsList">
                <div
                  class="person-entry"
                  data-role="affected"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 120px 40px;
                    gap: 0.5rem;
                    align-items: end;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div class="form-group" style="margin: 0">
                    <label class="form-label" style="font-size: 0.75rem"
                      >Name</label
                    >
                    <input
                      type="text"
                      class="form-input person-name"
                      placeholder="First and last name"
                      id="inputVictim"
                    />
                  </div>
                  <div class="form-group" style="margin: 0">
                    <label class="form-label" style="font-size: 0.75rem"
                      >Class/Role</label
                    >
                    <input
                      type="text"
                      class="form-input person-class"
                      placeholder="Class el. Personal"
                    />
                  </div>
                  <div></div>
                </div>
              </div>
              <button
                type="button"
                class="btn-add-person"
                onclick="addPerson('affectedPersonsList', 'affected')"
                style="
                  background: none;
                  border: 1px dashed var(--border);
                  border-radius: 6px;
                  padding: 0.5rem;
                  width: 100%;
                  color: var(--text-light);
                  cursor: pointer;
                  font-size: 0.8rem;
                "
              >
                + Add more affected
              </button>
            </div>

            <!-- SECTION: Witnesses -->
            <div
              class="person-section"
              style="
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 1rem;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 0.75rem;
                "
              >
                <span style="font-weight: 600; color: var(--primary-dark)"
                  >üëÅÔ∏è Witnesses</span
                >
                <span style="font-size: 0.75rem; color: var(--text-light)"
                  >People who witnessed the incident</span
                >
              </div>
              <div id="witnessesList">
                <div
                  class="person-entry"
                  data-role="witness"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 120px 40px;
                    gap: 0.5rem;
                    align-items: end;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div class="form-group" style="margin: 0">
                    <label class="form-label" style="font-size: 0.75rem"
                      >Name</label
                    >
                    <input
                      type="text"
                      class="form-input person-name"
                      placeholder="First and last name"
                      id="inputWitnesses"
                    />
                  </div>
                  <div class="form-group" style="margin: 0">
                    <label class="form-label" style="font-size: 0.75rem"
                      >Class/Role</label
                    >
                    <input
                      type="text"
                      class="form-input person-class"
                      placeholder="Class el. Personal"
                    />
                  </div>
                  <div></div>
                </div>
              </div>
              <button
                type="button"
                class="btn-add-person"
                onclick="addPerson('witnessesList', 'witness')"
                style="
                  background: none;
                  border: 1px dashed var(--border);
                  border-radius: 6px;
                  padding: 0.5rem;
                  width: 100%;
                  color: var(--text-light);
                  cursor: pointer;
                  font-size: 0.8rem;
                "
              >
                + Add more witnesses
              </button>
            </div>
          </div>

          <!-- Step 2: Category -->
          <div class="wizard-content" id="step2" style="display: none">
            <h2 class="wizard-title">What happened?</h2>
            <p class="wizard-desc">
              Select the category that best describes the incident
            </p>

            <div class="category-grid" id="categoryGrid">
              <!-- Filled by JS -->
            </div>

            <!-- Subcategories -->
            <div class="subcategory-section" id="subcatSection">
              <div class="subcategory-label">Specify type:</div>
              <div class="subcategory-tags" id="subcatTags">
                <!-- Filled by JS -->
              </div>
              <!-- Other free text field -->
              <div
                id="otherSubcatField"
                style="display: none; margin-top: 1rem"
              >
                <label class="form-label">Describe (Other):</label>
                <input
                  type="text"
                  class="form-input"
                  id="otherSubcatText"
                  placeholder="Describe the type of incident..."
                />
              </div>
            </div>

            <!-- Guidance -->
            <div id="guidanceBox"></div>
          </div>

          <!-- Step 3: Details -->
          <div class="wizard-content" id="step3" style="display: none">
            <h2 class="wizard-title">Describe the incident</h2>
            <p class="wizard-desc">Add details about what happened</p>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label"
                  >Severity <span class="required">*</span></label
                >
                <div class="severity-grid">
                  <div
                    class="severity-card minor"
                    onclick="selectSeverity(this, 'minor')"
                  >
                    <div class="severity-card-label">Minor</div>
                    <div class="severity-card-desc">Simple action</div>
                  </div>
                  <div
                    class="severity-card moderate"
                    onclick="selectSeverity(this, 'moderate')"
                  >
                    <div class="severity-card-label">Moderate</div>
                    <div class="severity-card-desc">Follow-up</div>
                  </div>
                  <div
                    class="severity-card serious"
                    onclick="selectSeverity(this, 'serious')"
                  >
                    <div class="severity-card-label">Serious</div>
                    <div class="severity-card-desc">Principal informeras</div>
                  </div>
                  <div
                    class="severity-card critical"
                    onclick="selectSeverity(this, 'critical')"
                  >
                    <div class="severity-card-label">Critical</div>
                    <div class="severity-card-desc">Immediate</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label"
                  >Date <span class="required">*</span></label
                >
                <input type="date" class="form-input" id="inputDate" />
              </div>
              <div class="form-group">
                <label class="form-label">Time (approximately)</label>
                <input type="time" class="form-input" id="inputTime" />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label"
                >Location <span class="required">*</span></label
              >
              <input
                type="text"
                class="form-input"
                placeholder="E.g. Classroom 204, Schoolyard"
                id="inputLocation"
              />
            </div>

            <div class="form-group">
              <label class="form-label"
                >Description <span class="required">*</span></label
              >
              <textarea
                class="form-textarea"
                placeholder="What happened? Who was involved? What led to the situation?"
                id="inputDescription"
              ></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Immediate actions taken</label>
              <textarea
                class="form-textarea"
                placeholder="What did you do immediately after the incident?"
                id="inputActions"
                style="min-height: 80px"
              ></textarea>
            </div>

            <div
              class="form-group"
              style="
                background: #f0f9ff;
                padding: 1rem;
                border-radius: 8px;
                border: 1px solid #bae6fd;
              "
            >
              <label class="form-label" style="color: #0369a1"
                >üìù Internal Notes / Follow-up</label
              >
              <textarea
                class="form-textarea"
                placeholder="E.g. Called parents - agreed to meet Friday 10:00. Mom was worried but cooperative. Next step: schedule meeting with counselor."
                id="inputNotes"
                style="min-height: 100px; background: white"
              ></textarea>
              <p style="font-size: 0.75rem; color: #0369a1; margin-top: 0.5rem">
                These notes will be saved with the case and visible to staff
                with access.
              </p>
            </div>
          </div>

          <!-- Step 4: Immediate Actions -->
          <div class="wizard-content" id="step4" style="display: none">
            <h2 class="wizard-title">Immediate Actions</h2>
            <p class="wizard-desc">
              Mark what you have done and who should be informed
            </p>

            <!-- Category-specific action checklist -->
            <div class="workflow-section">
              <div class="workflow-header">
                <span>‚úÖ Recommended Actions</span>
                <span class="workflow-progress" id="wizardActionProgress"
                  >0 of 0 marked</span
                >
              </div>
              <div class="workflow-body">
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-light);
                    margin-bottom: 1rem;
                  "
                >
                  Click to mark:
                  <span style="color: var(--text)">‚óã Not done</span> ‚Üí
                  <span style="color: var(--warning)">‚óê Planned</span> ‚Üí
                  <span style="color: var(--success)">‚úì Done</span> ‚Üí
                  <span style="opacity: 0.5">‚Äì Not applicable</span>
                </p>

                <div class="action-checklist" id="wizardActionChecklist">
                  <!-- Filled dynamically by JS based on category -->
                </div>
              </div>
            </div>

            <!-- Auto-share Warning (shown for serious categories/severity) -->
            <div
              id="autoShareWarning"
              class="guidance-box warning"
              style="
                display: none;
                margin-bottom: 1rem;
                background: #fff3cd;
                border: 1px solid #ffc107;
                border-radius: 8px;
                padding: 1rem;
              "
            >
              <div
                class="guidance-title"
                style="
                  color: #856404;
                  font-weight: 600;
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                "
              >
                ‚ö†Ô∏è Automatic Sharing
              </div>
              <div
                class="guidance-text"
                style="font-size: 0.85rem; color: #856404; margin-top: 0.5rem"
              >
                <p style="margin-bottom: 0.5rem">
                  This type of incident is automatically shared with:
                </p>
                <div id="autoShareRecipients" style="margin-left: 1rem">
                  <!-- Filled by JS -->
                </div>
                <p
                  style="
                    margin-top: 0.5rem;
                    font-size: 0.8rem;
                    font-style: italic;
                  "
                  id="autoShareReason"
                ></p>
              </div>
            </div>

            <!-- Notify Staff (renamed from Internal Escalation) -->
            <div class="workflow-section" style="margin-top: 1rem">
              <div class="workflow-header">
                <span>üë• Notify Staff</span>
                <span class="workflow-progress" id="wizardEscalationProgress"
                  >0 av 4 notified</span
                >
              </div>
              <div class="workflow-body">
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-light);
                    margin-bottom: 1rem;
                  "
                >
                  Mark who has been or should be notified about the case
                </p>

                <div id="wizardEscalationSteps">
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'mentor')"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Mentor/Class Teacher</div>
                      <div class="step-meta">
                        Student primary responsible teacher
                      </div>
                    </div>
                    <span class="step-status waiting">Not notified</span>
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'headofyear')"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Head of Year</div>
                      <div class="step-meta">When coordination is needed</div>
                    </div>
                    <span class="step-status waiting">Not notified</span>
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'counselor')"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Counselor</div>
                      <div class="step-meta">
                        For student welfare concerns or bullying
                      </div>
                    </div>
                    <span class="step-status waiting">Not notified</span>
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'principal')"
                    id="principalEscalation"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Principal</div>
                      <div class="step-meta">
                        Mandatory for harassment or serious incidents
                      </div>
                    </div>
                    <span class="step-status waiting">Not notified</span>
                  </div>
                </div>

                <div
                  id="externalEscalation"
                  style="
                    margin-top: 1rem;
                    padding-top: 1rem;
                    border-top: 1px solid var(--border);
                  "
                >
                  <div
                    style="
                      font-size: 0.8rem;
                      font-weight: 600;
                      color: var(--primary);
                      margin-bottom: 0.5rem;
                    "
                  >
                    üèõÔ∏è Authority Reports (if needed)
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'guardian')"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Guardians contacted</div>
                      <div class="step-meta">Parents of affected students</div>
                    </div>
                    <span class="step-status waiting">Not done</span>
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'socialservices')"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">
                        Welfare Report to social services
                      </div>
                      <div class="step-meta">
                        For child welfare concerns (14 kap. 1 ¬ß SoL)
                      </div>
                    </div>
                    <span class="step-status waiting">Not done</span>
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleWizardEscalation(this, 'police')"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Police Report</div>
                      <div class="step-meta">When crime is suspected</div>
                    </div>
                    <span class="step-status waiting">Not done</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- EHT Integration -->
            <div class="workflow-section" style="margin-top: 1rem">
              <div class="workflow-header">
                <span>üìã Student Health Team (EHT)</span>
              </div>
              <div class="workflow-body">
                <div
                  style="
                    display: flex;
                    gap: 1rem;
                    align-items: center;
                    flex-wrap: wrap;
                  "
                >
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      id="ehtCheckbox"
                      style="width: 18px; height: 18px"
                    />
                    <span style="font-size: 0.9rem"
                      >Add to next EHT meeting</span
                    >
                  </label>
                  <span
                    id="ehtMeetingInfo"
                    style="
                      font-size: 0.8rem;
                      color: var(--text-light);
                      display: none;
                    "
                  >
                    ‚Üí Will be discussed at EHT meeting
                    <strong id="ehtMeetingDate">Thursday 30/1</strong>
                  </span>
                </div>
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-light);
                    margin-top: 0.5rem;
                  "
                >
                  The case will be listed on the agenda for the next student
                  health team meeting.
                </p>
              </div>
            </div>

            <!-- File/Image Attachments -->
            <div class="workflow-section" style="margin-top: 1rem">
              <div class="workflow-header">
                <span>üìé Attachments</span>
                <span class="workflow-progress" id="attachmentCount"
                  >0 files</span
                >
              </div>
              <div class="workflow-body">
                <p
                  style="
                    font-size: 0.8rem;
                    color: var(--text-light);
                    margin-bottom: 0.75rem;
                  "
                >
                  Upload images, screenshots or other documents supporting the
                  report
                </p>
                <div id="attachmentsList" style="margin-bottom: 0.75rem"></div>
                <div
                  style="
                    border: 2px dashed var(--border);
                    border-radius: 8px;
                    padding: 1.5rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.2s;
                  "
                  onclick="document.getElementById('fileInput').click()"
                  onmouseover="
                    this.style.borderColor = 'var(--primary)';
                    this.style.background = '#f8fffe';
                  "
                  onmouseout="
                    this.style.borderColor = 'var(--border)';
                    this.style.background = 'transparent';
                  "
                >
                  <div style="font-size: 1.5rem; margin-bottom: 0.5rem">üì§</div>
                  <div style="font-size: 0.85rem; color: var(--text-light)">
                    Click to upload or drag files here
                  </div>
                  <div
                    style="
                      font-size: 0.75rem;
                      color: var(--text-light);
                      margin-top: 0.25rem;
                    "
                  >
                    Max 10 MB per fil. JPG, PNG, PDF, DOCX
                  </div>
                </div>
                <input
                  type="file"
                  id="fileInput"
                  multiple
                  accept=".jpg,.jpeg,.png,.pdf,.docx"
                  style="display: none"
                  onchange="handleFileUpload(this.files)"
                />
              </div>
            </div>
          </div>

          <!-- Step 5: Review -->
          <div class="wizard-content" id="step5" style="display: none">
            <h2 class="wizard-title">Purpose and Review</h2>
            <p class="wizard-desc">
              Specify why the incident is documented and review the information
            </p>

            <!-- Purpose Selection (GDPR) - Compact Dropdown -->
            <div
              style="
                background: #f0fff4;
                border: 1px solid #9ae6b4;
                border-radius: 8px;
                padding: 1rem 1.25rem;
                margin-bottom: 1.5rem;
              "
            >
              <div
                style="
                  font-size: 0.85rem;
                  font-weight: 600;
                  color: #22543d;
                  margin-bottom: 0.5rem;
                  display: flex;
                  align-items: center;
                  gap: 0.4rem;
                "
              >
                üîí Documentation Purpose (GDPR requirement)
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: #276749;
                  margin-bottom: 0.75rem;
                "
              >
                According to GDPR, the purpose of processing personal data must
                be specified.
              </div>
              <select
                id="purposeSelect"
                class="form-input"
                style="width: 100%; font-size: 0.9rem"
                onchange="updatePurposeSelection(this.value)"
              >
                <option value="">-- Select documentation purpose --</option>
                <option value="disciplinary">
                  Disciplinary Action (5 kap. Education Act)
                </option>
                <option value="harassment">
                  Harassment / Investigation (6 kap. 10 ¬ß)
                </option>
                <option value="safety">
                  Safety Incident (Work Environment Act)
                </option>
                <option value="welfare">
                  Student Welfare Concern (Chapter 14 Section 1 SoL)
                </option>
                <option value="quality">
                  Systematic Quality Work (4 kap. Education Act)
                </option>
              </select>
              <div
                id="purposeDescription"
                style="
                  font-size: 0.75rem;
                  color: #276749;
                  margin-top: 0.5rem;
                  display: none;
                "
              ></div>
            </div>

            <!-- Review Summary -->
            <div class="card" style="margin-bottom: 1rem">
              <div class="card-header">Summary</div>
              <div class="card-body">
                <div class="info-grid" id="reviewContent">
                  <!-- Filled by JS -->
                </div>
              </div>
            </div>

            <div
              class="guidance-box warning"
              id="reviewWarning"
              style="display: none"
            >
              <div class="guidance-title">‚ö†Ô∏è Note</div>
              <div class="guidance-text" id="reviewWarningText"></div>
            </div>

            <!-- Retention Info -->
            <div
              style="
                background: #f0fff4;
                border: 1px solid #9ae6b4;
                border-radius: 8px;
                padding: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  font-size: 0.85rem;
                  font-weight: 600;
                  color: #22543d;
                  margin-bottom: 0.5rem;
                "
              >
                üìÖ Retention Information
              </div>
              <div style="font-size: 0.8rem; color: #276749">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    padding: 0.3rem 0;
                  "
                >
                  <span>Retention period:</span>
                  <strong id="retentionPeriod">12 months</strong>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    padding: 0.3rem 0;
                  "
                >
                  <span>Planned gallring:</span>
                  <strong id="deletionDate">2026-01-26</strong>
                </div>
              </div>
            </div>
          </div>

          <div class="wizard-footer">
            <button
              class="btn btn-ghost"
              id="prevBtn"
              onclick="prevStep()"
              style="visibility: hidden"
            >
              ‚Üê Back
            </button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
              Next ‚Üí
            </button>
          </div>
        </div>
      </div>

      <!-- ========== SUCCESS PAGE ========== -->
      <div class="page" id="page-success">
        <div class="card">
          <div class="success-page">
            <div class="success-icon">‚úì</div>
            <h2 class="success-title">Incidenten har dokumenterats</h2>
            <p class="success-text">
              Case number: <strong id="caseNumber">INC-2025-0042</strong
              ><br />Relevant parties have been notified according to settings.
            </p>
            <div class="success-actions">
              <button class="btn btn-secondary" onclick="showPage('list')">
                View Casen
              </button>
              <button
                class="btn btn-primary"
                onclick="
                  showPage('report');
                  resetWizard();
                "
              >
                Dokumentera ny
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== INCIDENT DETAIL ========== -->
      <div class="page" id="page-detail">
        <span class="back-link" onclick="showPage('list')"
          >‚Üê Back till lista</span
        >

        <div class="detail-header">
          <div>
            <h1 class="detail-title" id="detailTitle">Verbal mobbning</h1>
            <p class="detail-subtitle" id="detailSubtitle">
              Erik Johansson ‚Ä¢ Grade 8B ‚Ä¢ Documented 2025-01-24
            </p>
          </div>
          <span class="status-badge status-progress" id="detailStatus"
            >Under investigation</span
          >
        </div>

        <div class="detail-grid">
          <div>
            <!-- Info Card -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">Information</div>
              <div class="card-body">
                <div class="info-grid" id="detailInfo">
                  <!-- Filled by JS -->
                </div>
              </div>
            </div>

            <!-- Description -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">Description</div>
              <div class="card-body">
                <p
                  id="detailDescription"
                  style="font-size: 0.9rem; line-height: 1.7"
                ></p>
                <div
                  style="
                    margin-top: 1rem;
                    padding-top: 1rem;
                    border-top: 1px solid var(--border);
                  "
                >
                  <strong style="font-size: 0.85rem; color: var(--text-light)"
                    >Actions taken:</strong
                  >
                  <p
                    id="detailActions"
                    style="margin-top: 0.5rem; font-size: 0.9rem"
                  ></p>
                </div>
              </div>
            </div>

            <!-- INTERNAL ESCALATION WORKFLOW -->
            <div class="workflow-section" id="escalationWorkflow">
              <div class="workflow-header">
                <span>üë• Notify Staff</span>
                <span class="workflow-progress" id="escalationProgress"
                  >2 av 4 completed</span
                >
              </div>
              <div class="workflow-body">
                <div class="escalation-chain" id="escalationChain">
                  <div class="escalation-step">
                    <span class="escalation-badge done">Reporter</span>
                    <span class="escalation-arrow">‚Üí</span>
                  </div>
                  <div class="escalation-step">
                    <span class="escalation-badge done">Mentor</span>
                    <span class="escalation-arrow">‚Üí</span>
                  </div>
                  <div class="escalation-step">
                    <span class="escalation-badge active">Counselor</span>
                    <span class="escalation-arrow">‚Üí</span>
                  </div>
                  <div class="escalation-step">
                    <span class="escalation-badge">Principal</span>
                  </div>
                </div>

                <div style="margin-top: 1rem" id="escalationSteps">
                  <div
                    class="workflow-step completed"
                    onclick="toggleEscalationStep(this, 0)"
                  >
                    <div class="step-checkbox">‚úì</div>
                    <div class="step-content">
                      <div class="step-title">Mentor notified</div>
                      <div class="step-meta">Anna Lindstr√∂m</div>
                    </div>
                    <span class="step-status done">Completet 14:30</span>
                  </div>
                  <div
                    class="workflow-step completed"
                    onclick="toggleEscalationStep(this, 1)"
                  >
                    <div class="step-checkbox">‚úì</div>
                    <div class="step-content">
                      <div class="step-title">Head of Year notified</div>
                      <div class="step-meta">Johan Eriksson</div>
                    </div>
                    <span class="step-status done">Completet 14:45</span>
                  </div>
                  <div
                    class="workflow-step planned"
                    onclick="toggleEscalationStep(this, 2)"
                  >
                    <div class="step-checkbox">‚óê</div>
                    <div class="step-content">
                      <div class="step-title">Counselor notified</div>
                      <div class="step-meta">Lisa Bergstr√∂m</div>
                    </div>
                    <span class="step-status pending">In progress</span>
                  </div>
                  <div
                    class="workflow-step"
                    onclick="toggleEscalationStep(this, 3)"
                  >
                    <div class="step-checkbox"></div>
                    <div class="step-content">
                      <div class="step-title">Principal notified</div>
                      <div class="step-meta">
                        Required for serious harassment
                      </div>
                    </div>
                    <span class="step-status waiting">Waiting</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- PREDEFINED ACTIONS CHECKLIST -->
            <div class="workflow-section" id="actionChecklist">
              <div class="workflow-header">
                <span>‚úÖ Actions to Take</span>
                <span class="workflow-progress" id="actionProgress"
                  >5 av 12 completed</span
                >
              </div>
              <div class="workflow-body">
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-light);
                    margin-bottom: 1rem;
                  "
                >
                  Click to change status:
                  <span style="color: var(--text)">‚óã Not selected</span> ‚Üí
                  <span style="color: var(--warning)">‚óê Planned</span> ‚Üí
                  <span style="color: var(--success)">‚úì Complete</span>
                </p>

                <div class="action-checklist" id="actionChecklistItems">
                  <!-- Meetings & Conversations -->
                  <div class="action-group">
                    <div class="action-group-title">
                      üë• Meetings & Conversations
                    </div>
                    <div
                      class="action-item state-done"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚úì</div>
                      <span class="action-label"
                        >Talk with involved student</span
                      >
                      <span class="action-date">2025-01-24</span>
                    </div>
                    <div
                      class="action-item state-done"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚úì</div>
                      <span class="action-label"
                        >Talk with affected student</span
                      >
                      <span class="action-date">2025-01-24</span>
                    </div>
                    <div
                      class="action-item state-planned"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚óê</div>
                      <span class="action-label">Talk with witnesses</span>
                      <span class="action-date">Planerat 01-27</span>
                    </div>
                    <div class="action-item" onclick="cycleActionState(this)">
                      <div class="action-toggle"></div>
                      <span class="action-label"
                        >Class council/group discussion</span
                      >
                      <span class="action-date"></span>
                    </div>
                    <div class="action-item" onclick="cycleActionState(this)">
                      <div class="action-toggle"></div>
                      <span class="action-label"
                        >Meeting with student health team (EHT)</span
                      >
                      <span class="action-date"></span>
                    </div>
                  </div>

                  <!-- Guardians -->
                  <div class="action-group">
                    <div class="action-group-title">üë®‚Äçüë©‚Äçüëß Guardians</div>
                    <div
                      class="action-item state-done"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚úì</div>
                      <span class="action-label"
                        >Contact guardians (involved student)</span
                      >
                      <span class="action-date">2025-01-24</span>
                    </div>
                    <div
                      class="action-item state-done"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚úì</div>
                      <span class="action-label"
                        >Contact guardians (affected student)</span
                      >
                      <span class="action-date">2025-01-24</span>
                    </div>
                    <div
                      class="action-item state-planned"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚óê</div>
                      <span class="action-label"
                        >Meeting with all guardians</span
                      >
                      <span class="action-date">Planerat 01-29</span>
                    </div>
                  </div>

                  <!-- Documentation -->
                  <div class="action-group">
                    <div class="action-group-title">üìÑ Documentation</div>
                    <div
                      class="action-item state-done"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚úì</div>
                      <span class="action-label"
                        >Documented in student file</span
                      >
                      <span class="action-date">2025-01-24</span>
                    </div>
                    <div
                      class="action-item state-planned"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚óê</div>
                      <span class="action-label">Action plan established</span>
                      <span class="action-date">In progress</span>
                    </div>
                    <div class="action-item" onclick="cycleActionState(this)">
                      <div class="action-toggle"></div>
                      <span class="action-label">Follow-up date set</span>
                      <span class="action-date"></span>
                    </div>
                  </div>

                  <!-- Externall Actions -->
                  <div class="action-group">
                    <div class="action-group-title">üèõÔ∏è Externall Actions</div>
                    <div
                      class="action-item state-na"
                      onclick="cycleActionState(this)"
                    >
                      <div class="action-toggle">‚Äì</div>
                      <span class="action-label">Police Report</span>
                      <span class="action-date">Not applicable</span>
                    </div>
                    <div class="action-item" onclick="cycleActionState(this)">
                      <div class="action-toggle"></div>
                      <span class="action-label"
                        >Welfare Report to social services</span
                      >
                      <span class="action-date"></span>
                    </div>
                    <div class="action-item" onclick="cycleActionState(this)">
                      <div class="action-toggle"></div>
                      <span class="action-label"
                        >Report to school authority</span
                      >
                      <span class="action-date"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Legal Requirements (shown for serious cases) -->
            <div
              class="card hidden"
              id="legalCard"
              style="margin-bottom: 1.5rem"
            >
              <div class="card-header">Legal Requirements</div>
              <div class="card-body">
                <div class="legal-box">
                  <div class="legal-title">‚öñÔ∏è Actions required by law</div>
                  <div id="legalItems">
                    <!-- Filled by JS -->
                  </div>
                </div>
              </div>
            </div>

            <!-- GDPR & Data Retention -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">GDPR & Retention</div>
              <div class="card-body">
                <div
                  style="
                    background: #f0fff4;
                    border: 1px solid #9ae6b4;
                    border-radius: 8px;
                    padding: 1rem;
                  "
                >
                  <div
                    style="
                      font-size: 0.85rem;
                      font-weight: 600;
                      color: #22543d;
                      margin-bottom: 0.5rem;
                    "
                  >
                    üîí Processing of personal data
                  </div>
                  <div style="font-size: 0.8rem; color: #276749">
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        padding: 0.3rem 0;
                        border-bottom: 1px solid #c6f6d5;
                      "
                    >
                      <span>Documentationssyfte:</span>
                      <strong id="detailPurpose">Harassment</strong>
                    </div>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        padding: 0.3rem 0;
                        border-bottom: 1px solid #c6f6d5;
                      "
                    >
                      <span>Legal basis:</span>
                      <strong id="detailLegalBasis"
                        >6 kap. 10 ¬ß Education Act</strong
                      >
                    </div>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        padding: 0.3rem 0;
                        border-bottom: 1px solid #c6f6d5;
                      "
                    >
                      <span>Dokumenterat:</span>
                      <strong id="detailCreated">2025-01-24</strong>
                    </div>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        padding: 0.3rem 0;
                      "
                    >
                      <span>Deletion date:</span>
                      <strong id="detailDeletion">2026-01-24</strong>
                    </div>
                  </div>
                </div>
                <div
                  style="
                    background: #ebf8ff;
                    border: 1px solid #90cdf4;
                    border-radius: 8px;
                    padding: 1rem;
                    margin-top: 1rem;
                  "
                >
                  <div
                    style="
                      font-size: 0.85rem;
                      font-weight: 600;
                      color: #2b6cb0;
                      margin-bottom: 0.5rem;
                    "
                  >
                    üì§ Data Export (GDPR Art. 15)
                  </div>
                  <div
                    style="
                      font-size: 0.8rem;
                      color: #2c5282;
                      margin-bottom: 0.75rem;
                    "
                  >
                    Export all documentation about this student.
                  </div>
                  <button
                    class="btn btn-sm btn-secondary"
                    onclick="exportStudentData()"
                  >
                    Export student data
                  </button>
                </div>
              </div>
            </div>

            <!-- PARENT COMMUNICATION LOG -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">
                üìû Contact with Guardians
                <button
                  class="btn btn-sm btn-ghost"
                  onclick="addParentContact()"
                >
                  + Add
                </button>
              </div>
              <div class="card-body" id="parentContactLog">
                <div
                  class="contact-entry"
                  style="
                    border-left: 3px solid var(--success);
                    padding-left: 1rem;
                    margin-bottom: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <div>
                      <strong style="font-size: 0.85rem">üìû Phone call</strong>
                      <span
                        style="
                          font-size: 0.75rem;
                          color: var(--text-light);
                          margin-left: 0.5rem;
                        "
                        >Maria Andersson</span
                      >
                    </div>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-24 14:30</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    Informed mother about the incident. She understood the
                    situation and thanked for the information. Agreed on
                    follow-up next week.
                  </p>
                </div>
                <div
                  class="contact-entry"
                  style="
                    border-left: 3px solid var(--warning);
                    padding-left: 1rem;
                    margin-bottom: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <div>
                      <strong style="font-size: 0.85rem">‚úâÔ∏è Email sent</strong>
                      <span
                        style="
                          font-size: 0.75rem;
                          color: var(--text-light);
                          margin-left: 0.5rem;
                        "
                        >Maria Andersson</span
                      >
                    </div>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-25 09:00</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    Meeting invitation sent 28/1 kl 15:00 sent to both
                    guardians.
                  </p>
                </div>
                <div
                  class="contact-entry"
                  style="
                    border-left: 3px solid var(--primary);
                    padding-left: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <div>
                      <strong style="font-size: 0.85rem"
                        >ü§ù Meeting completed</strong
                      >
                      <span
                        style="
                          font-size: 0.75rem;
                          color: var(--text-light);
                          margin-left: 0.5rem;
                        "
                        >Maria Andersson</span
                      >
                    </div>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-28 15:00</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    Meeting with both parents och Erik. Discussed action plan.
                    Parents supportive. Next follow-up: 2025-02-11.
                  </p>
                </div>
              </div>
            </div>

            <!-- CASE NOTES / INTERNAL LOG -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">
                üìù Case Notes
                <button
                  class="btn btn-sm btn-primary"
                  onclick="addCaseNote()"
                  style="background: var(--primary)"
                >
                  + Add Note
                </button>
              </div>
              <div class="card-body" id="caseNotesLog">
                <div
                  class="note-entry"
                  style="
                    border-left: 3px solid #718096;
                    padding-left: 1rem;
                    margin-bottom: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <strong style="font-size: 0.85rem">Maria Andersson</strong>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-30 15:45</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    Tried calling mother, no answer. Left voicemail requesting
                    callback.
                  </p>
                </div>
                <div
                  class="note-entry"
                  style="
                    border-left: 3px solid #718096;
                    padding-left: 1rem;
                    margin-bottom: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <strong style="font-size: 0.85rem">Anna Lindstr√∂m</strong>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-30 09:30</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    Spoke with Erik during break. He seems down and doesn't want
                    to talk about what happened. Will continue to keep an eye on
                    him.
                  </p>
                </div>
                <div
                  class="note-entry"
                  style="
                    border-left: 3px solid #718096;
                    padding-left: 1rem;
                    margin-bottom: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <strong style="font-size: 0.85rem">Lisa Bergstr√∂m</strong>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-28 16:20</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    First support session with Erik completed. He opened up a
                    bit about the situation at home. Planning follow-up
                    Wednesday.
                  </p>
                </div>
                <div
                  class="note-entry"
                  style="
                    border-left: 3px solid var(--success);
                    padding-left: 1rem;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-start;
                    "
                  >
                    <strong style="font-size: 0.85rem">Maria Andersson</strong>
                    <span style="font-size: 0.75rem; color: var(--text-light)"
                      >2025-01-29 14:00</span
                    >
                  </div>
                  <p
                    style="
                      font-size: 0.8rem;
                      color: var(--text);
                      margin-top: 0.25rem;
                    "
                  >
                    Mother called back. Agreed on meeting Friday 10:00. She was
                    worried but cooperative. Father will also attend.
                  </p>
                </div>
              </div>
            </div>

            <!-- PREVIOUS INCIDENTS FOR STUDENT -->
            <div
              class="card hidden"
              id="previousIncidentsCard"
              style="margin-bottom: 1.5rem"
            >
              <div
                class="card-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span>‚ö†Ô∏è Previous cases for this student</span>
                <span
                  class="badge"
                  style="
                    background: #fef3c7;
                    color: #92400e;
                    font-size: 0.7rem;
                    padding: 0.2rem 0.5rem;
                    border-radius: 12px;
                  "
                  id="prevIncidentCount"
                  >2 cases</span
                >
              </div>
              <div class="card-body" id="previousIncidentsList">
                <div
                  onclick="showIncident(15)"
                  style="
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    margin-bottom: 0.5rem;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                  class="prev-incident-item"
                >
                  <div>
                    <strong style="font-size: 0.85rem"
                      >Disruptive behavior</strong
                    >
                    <div style="font-size: 0.75rem; color: var(--text-light)">
                      2024-11-15 ‚Ä¢ Closed
                    </div>
                  </div>
                  <span
                    class="status-badge status-closed"
                    style="font-size: 0.7rem"
                    >Closed</span
                  >
                </div>
                <div
                  onclick="showIncident(8)"
                  style="
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                  class="prev-incident-item"
                >
                  <div>
                    <strong style="font-size: 0.85rem">Verbal conflict</strong>
                    <div style="font-size: 0.75rem; color: var(--text-light)">
                      2024-09-22 ‚Ä¢ Closed
                    </div>
                  </div>
                  <span
                    class="status-badge status-closed"
                    style="font-size: 0.7rem"
                    >Closed</span
                  >
                </div>
              </div>
              <div
                style="
                  padding: 0.75rem;
                  background: #fef3c7;
                  border-radius: 0 0 8px 8px;
                  font-size: 0.8rem;
                  color: #92400e;
                "
              >
                ‚ö†Ô∏è <strong>Pattern detected:</strong> 3rd incident in the last
                90 days
              </div>
            </div>
          </div>

          <div>
            <!-- Action Toolbox -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">
                Actions
                <button
                  class="btn btn-sm btn-ghost"
                  onclick="showModal('addActionModal')"
                >
                  + Add
                </button>
              </div>
              <div class="card-body">
                <ul class="action-toolbox" id="actionToolbox">
                  <!-- Filled by JS -->
                </ul>
                <button
                  class="add-action-btn"
                  onclick="showModal('addActionModal')"
                >
                  + Add other action
                </button>
              </div>
            </div>

            <!-- Timeline -->
            <div class="card" style="margin-bottom: 1.5rem">
              <div class="card-header">Timeline</div>
              <div class="card-body">
                <ul class="timeline" id="timeline">
                  <!-- Filled by JS -->
                </ul>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
              <div class="card-header">Quick Actions</div>
              <div
                class="card-body"
                style="display: flex; flex-direction: column; gap: 0.5rem"
              >
                <button
                  class="btn btn-secondary btn-sm"
                  onclick="showModal('escalateModal')"
                >
                  üì§ Escalate case
                </button>
                <button
                  class="btn btn-secondary btn-sm"
                  onclick="showModal('documentModal')"
                >
                  üìÑ Create document
                </button>
                <button class="btn btn-secondary btn-sm" onclick="closeCase()">
                  ‚úì Mark as closed
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== TASKS PAGE ========== -->
      <div class="page" id="page-tasks">
        <span class="back-link" onclick="showPage('dashboard')">‚Üê Back</span>

        <h2 class="section-title" style="margin-bottom: 0.5rem">üìã My Tasks</h2>
        <p
          style="
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
          "
        >
          Tasks you need to complete from your cases
        </p>

        <!-- Task Filters -->
        <div
          style="
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
          "
        >
          <button
            class="btn btn-sm task-filter-btn active"
            onclick="filterTasks('all', this)"
            style="font-size: 0.8rem"
          >
            All (5)
          </button>
          <button
            class="btn btn-sm btn-ghost task-filter-btn"
            onclick="filterTasks('overdue', this)"
            style="font-size: 0.8rem; color: #c53030"
          >
            Overdue (1)
          </button>
          <button
            class="btn btn-sm btn-ghost task-filter-btn"
            onclick="filterTasks('today', this)"
            style="font-size: 0.8rem"
          >
            Today (1)
          </button>
          <button
            class="btn btn-sm btn-ghost task-filter-btn"
            onclick="filterTasks('week', this)"
            style="font-size: 0.8rem"
          >
            This week (2)
          </button>
          <button
            class="btn btn-sm btn-ghost task-filter-btn"
            onclick="filterTasks('planned', this)"
            style="font-size: 0.8rem"
          >
            Plannede (1)
          </button>
        </div>

        <!-- Task List -->
        <div id="taskListContainer">
          <!-- Overdue -->
          <div class="task-section" data-filter="overdue today all">
            <div
              style="
                font-size: 0.8rem;
                font-weight: 600;
                color: #c53030;
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <span>üî¥</span> Overdue
            </div>
            <div
              class="task-item"
              onclick="showIncident(3)"
              style="
                background: white;
                border: 1px solid var(--border);
                border-left: 4px solid #c53030;
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                  margin-bottom: 0.5rem;
                "
              >
                <div style="font-weight: 500; font-size: 0.9rem">
                  Meeting with EHT
                </div>
                <select
                  class="task-status-select"
                  onclick="event.stopPropagation()"
                  onchange="updateTaskStatus(this, 3)"
                  style="
                    font-size: 0.75rem;
                    padding: 0.25rem 0.5rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                >
                  <option value="pending">Not started</option>
                  <option value="planned" selected>Planned</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Complete</option>
                  <option value="na">Not applicable</option>
                </select>
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  margin-bottom: 0.5rem;
                "
              >
                <strong>INC-2025-0040</strong> ‚Ä¢ Kevin Lindqvist ‚Ä¢ 9B
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span
                  style="font-size: 0.75rem; color: #c53030; font-weight: 500"
                  >Due date: 2025-01-27 (3 days ago)</span
                >
                <input
                  type="date"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.2rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                  value="2025-01-27"
                />
              </div>
            </div>
          </div>

          <!-- Today -->
          <div class="task-section" data-filter="today all">
            <div
              style="
                font-size: 0.8rem;
                font-weight: 600;
                color: #dd6b20;
                margin-bottom: 0.5rem;
                margin-top: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <span>üü†</span> Today
            </div>
            <div
              class="task-item"
              onclick="showIncident(2)"
              style="
                background: white;
                border: 1px solid var(--border);
                border-left: 4px solid #dd6b20;
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                  margin-bottom: 0.5rem;
                "
              >
                <div style="font-weight: 500; font-size: 0.9rem">
                  Contact with guardians (Erik)
                </div>
                <select
                  class="task-status-select"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.25rem 0.5rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                >
                  <option value="pending">Not started</option>
                  <option value="planned" selected>Planned</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Complete</option>
                  <option value="na">Not applicable</option>
                </select>
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  margin-bottom: 0.5rem;
                "
              >
                <strong>INC-2025-0042</strong> ‚Ä¢ Erik Johansson ‚Ä¢ 8B
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span
                  style="font-size: 0.75rem; color: #dd6b20; font-weight: 500"
                  >Due date: Today</span
                >
                <input
                  type="date"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.2rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                  value="2025-01-30"
                />
              </div>
            </div>
          </div>

          <!-- This Week -->
          <div class="task-section" data-filter="week all">
            <div
              style="
                font-size: 0.8rem;
                font-weight: 600;
                color: #2b6cb0;
                margin-bottom: 0.5rem;
                margin-top: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <span>üîµ</span> This week
            </div>
            <div
              class="task-item"
              onclick="showIncident(1)"
              style="
                background: white;
                border: 1px solid var(--border);
                border-left: 4px solid #2b6cb0;
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                  margin-bottom: 0.5rem;
                "
              >
                <div style="font-weight: 500; font-size: 0.9rem">
                  Follow-up with counselor
                </div>
                <select
                  class="task-status-select"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.25rem 0.5rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                >
                  <option value="pending">Not started</option>
                  <option value="planned" selected>Planned</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Complete</option>
                  <option value="na">Not applicable</option>
                </select>
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  margin-bottom: 0.5rem;
                "
              >
                <strong>INC-2025-0041</strong> ‚Ä¢ Oscar Nilsson ‚Ä¢ 9A
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span style="font-size: 0.75rem; color: #2b6cb0"
                  >Due date: 2025-01-31</span
                >
                <input
                  type="date"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.2rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                  value="2025-01-31"
                />
              </div>
            </div>
            <div
              class="task-item"
              onclick="showIncident(5)"
              style="
                background: white;
                border: 1px solid var(--border);
                border-left: 4px solid #2b6cb0;
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                  margin-bottom: 0.5rem;
                "
              >
                <div style="font-weight: 500; font-size: 0.9rem">
                  Inform mentor about incident
                </div>
                <select
                  class="task-status-select"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.25rem 0.5rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                >
                  <option value="pending" selected>Not started</option>
                  <option value="planned">Planned</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Complete</option>
                  <option value="na">Not applicable</option>
                </select>
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  margin-bottom: 0.5rem;
                "
              >
                <strong>INC-2025-0045</strong> ‚Ä¢ Adam Svensson ‚Ä¢ 8A
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span style="font-size: 0.75rem; color: #2b6cb0"
                  >Due date: 2025-02-01</span
                >
                <input
                  type="date"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.2rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                  value="2025-02-01"
                />
              </div>
            </div>
          </div>

          <!-- Planned/Future -->
          <div class="task-section" data-filter="planned all">
            <div
              style="
                font-size: 0.8rem;
                font-weight: 600;
                color: #718096;
                margin-bottom: 0.5rem;
                margin-top: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <span>‚ö™</span> Upcoming
            </div>
            <div
              class="task-item"
              onclick="showIncident(7)"
              style="
                background: white;
                border: 1px solid var(--border);
                border-left: 4px solid #a0aec0;
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                  margin-bottom: 0.5rem;
                "
              >
                <div style="font-weight: 500; font-size: 0.9rem">
                  Evaluate actions
                </div>
                <select
                  class="task-status-select"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.25rem 0.5rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                >
                  <option value="pending" selected>Not started</option>
                  <option value="planned">Planned</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Complete</option>
                  <option value="na">Not applicable</option>
                </select>
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  margin-bottom: 0.5rem;
                "
              >
                <strong>INC-2025-0038</strong> ‚Ä¢ Wilma Andersson ‚Ä¢ 7B
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span style="font-size: 0.75rem; color: #718096"
                  >Due date: 2025-02-07</span
                >
                <input
                  type="date"
                  onclick="event.stopPropagation()"
                  style="
                    font-size: 0.75rem;
                    padding: 0.2rem;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                  "
                  value="2025-02-07"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== EHT PAGE ========== -->
      <div class="page" id="page-eht">
        <span class="back-link" onclick="showPage('dashboard')">‚Üê Back</span>

        <h2 class="section-title" style="margin-bottom: 0.5rem">
          üè• Student Health Team (EHT)
        </h2>
        <p
          style="
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
          "
        >
          Hantera EHT Meetings och cases
        </p>

        <!-- EHT Tabs -->
        <div
          style="
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
          "
        >
          <button
            class="btn btn-sm eht-tab active"
            onclick="showEhtTab('upcoming')"
            id="ehtTabUpcoming"
          >
            Upcoming Meeting
          </button>
          <button
            class="btn btn-sm btn-ghost eht-tab"
            onclick="showEhtTab('history')"
            id="ehtTabHistory"
          >
            Past Meetings
          </button>
          <button
            class="btn btn-sm btn-ghost eht-tab"
            onclick="showEhtTab('settings')"
            id="ehtTabSettings"
          >
            Settings
          </button>
        </div>

        <!-- Upcoming Meeting Panel -->
        <div class="eht-panel" id="ehtPanelUpcoming">
          <!-- Meeting Header -->
          <div
            class="card"
            style="
              margin-bottom: 1.5rem;
              background: linear-gradient(135deg, #ebf8ff 0%, #fff 100%);
            "
          >
            <div class="card-body">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                  flex-wrap: wrap;
                  gap: 1rem;
                "
              >
                <div>
                  <div
                    style="
                      font-size: 0.8rem;
                      color: var(--text-light);
                      margin-bottom: 0.25rem;
                    "
                  >
                    Next EHT Meeting
                  </div>
                  <div
                    style="
                      font-size: 1.25rem;
                      font-weight: 600;
                      color: var(--primary-dark);
                    "
                    id="ehtNextMeetingDate"
                  >
                    Thursday 30 januari 2025, kl 14:00
                  </div>
                  <div
                    style="
                      font-size: 0.85rem;
                      color: var(--text-light);
                      margin-top: 0.25rem;
                    "
                    id="ehtNextMeetingLocation"
                  >
                    Conference Room B
                  </div>
                </div>
                <div style="text-align: right">
                  <div
                    style="
                      font-size: 2rem;
                      font-weight: 700;
                      color: var(--primary);
                    "
                    id="ehtAgendaCount"
                  >
                    4
                  </div>
                  <div style="font-size: 0.8rem; color: var(--text-light)">
                    cases on agenda
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Attendance -->
          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">Participants</div>
            <div class="card-body">
              <div style="display: flex; flex-wrap: wrap; gap: 0.75rem">
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 0.75rem;
                    background: #f7fafc;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  <input type="checkbox" checked />
                  <span style="font-size: 0.85rem">Principal</span>
                </label>
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 0.75rem;
                    background: #f7fafc;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  <input type="checkbox" checked />
                  <span style="font-size: 0.85rem">Counselor</span>
                </label>
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 0.75rem;
                    background: #f7fafc;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  <input type="checkbox" checked />
                  <span style="font-size: 0.85rem">School Nurse</span>
                </label>
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 0.75rem;
                    background: #f7fafc;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  <input type="checkbox" />
                  <span style="font-size: 0.85rem">School Psychologist</span>
                </label>
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 0.75rem;
                    background: #f7fafc;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  <input type="checkbox" checked />
                  <span style="font-size: 0.85rem"
                    >Special Education Teacher</span
                  >
                </label>
              </div>
            </div>
          </div>

          <!-- Agenda -->
          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">
              Agenda
              <span
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  font-weight: normal;
                "
                >4 cases</span
              >
            </div>
            <div class="card-body" style="padding: 0">
              <!-- Agenda Item 1 -->
              <div
                class="eht-agenda-item"
                style="padding: 1rem; border-bottom: 1px solid var(--border)"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span
                      style="
                        background: var(--error);
                        color: white;
                        padding: 0.15rem 0.4rem;
                        border-radius: 4px;
                        font-size: 0.7rem;
                        font-weight: 600;
                      "
                      >HIGH</span
                    >
                    <strong style="font-size: 0.9rem"
                      >Erik Johansson (8B)</strong
                    >
                  </div>
                  <span
                    class="status-badge status-progress"
                    style="font-size: 0.7rem"
                    >Under investigation</span
                  >
                </div>
                <div
                  style="
                    font-size: 0.85rem;
                    color: var(--text);
                    margin-bottom: 0.5rem;
                  "
                >
                  <strong>Harassment</strong> - Verbal mobbning under flera
                  veckor
                </div>
                <div
                  style="
                    font-size: 0.8rem;
                    color: var(--text-light);
                    margin-bottom: 0.75rem;
                  "
                >
                  Reported by: Maria Andersson ‚Ä¢ INC-2025-0042
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showIncident(2)"
                  >
                    View Case
                  </button>
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showEhtDecisionModal(2, 'Erik Johansson')"
                  >
                    üìù Record decision
                  </button>
                </div>
              </div>

              <!-- Agenda Item 2 -->
              <div
                class="eht-agenda-item"
                style="padding: 1rem; border-bottom: 1px solid var(--border)"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span
                      style="
                        background: var(--warning);
                        color: white;
                        padding: 0.15rem 0.4rem;
                        border-radius: 4px;
                        font-size: 0.7rem;
                        font-weight: 600;
                      "
                      >MEDIUM</span
                    >
                    <strong style="font-size: 0.9rem"
                      >Oscar Nilsson (9A)</strong
                    >
                  </div>
                  <span
                    class="status-badge status-open"
                    style="font-size: 0.7rem"
                    >Open</span
                  >
                </div>
                <div
                  style="
                    font-size: 0.85rem;
                    color: var(--text);
                    margin-bottom: 0.5rem;
                  "
                >
                  <strong>Welfare Concern</strong> - Changed behavior, social
                  withdrawal
                </div>
                <div
                  style="
                    font-size: 0.8rem;
                    color: var(--text-light);
                    margin-bottom: 0.75rem;
                  "
                >
                  Reported by: Anna Lindstr√∂m ‚Ä¢ INC-2025-0041
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showIncident(1)"
                  >
                    View Case
                  </button>
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showEhtDecisionModal(1, 'Oscar Nilsson')"
                  >
                    üìù Record decision
                  </button>
                </div>
              </div>

              <!-- Agenda Item 3 -->
              <div
                class="eht-agenda-item"
                style="padding: 1rem; border-bottom: 1px solid var(--border)"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span
                      style="
                        background: var(--warning);
                        color: white;
                        padding: 0.15rem 0.4rem;
                        border-radius: 4px;
                        font-size: 0.7rem;
                        font-weight: 600;
                      "
                      >MEDIUM</span
                    >
                    <strong style="font-size: 0.9rem"
                      >Kevin Lindqvist (9B)</strong
                    >
                  </div>
                  <span
                    class="status-badge status-action"
                    style="font-size: 0.7rem"
                    >Action required</span
                  >
                </div>
                <div
                  style="
                    font-size: 0.85rem;
                    color: var(--text);
                    margin-bottom: 0.5rem;
                  "
                >
                  <strong>Repeated disruptions</strong> - 3rd incident this
                  month
                </div>
                <div
                  style="
                    font-size: 0.8rem;
                    color: var(--text-light);
                    margin-bottom: 0.75rem;
                  "
                >
                  Reported by: Johan Eriksson ‚Ä¢ INC-2025-0040
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showIncident(3)"
                  >
                    View Case
                  </button>
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showEhtDecisionModal(3, 'Kevin Lindqvist')"
                  >
                    üìù Record decision
                  </button>
                </div>
              </div>

              <!-- Agenda Item 4 -->
              <div class="eht-agenda-item" style="padding: 1rem">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 0.5rem;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span
                      style="
                        background: #718096;
                        color: white;
                        padding: 0.15rem 0.4rem;
                        border-radius: 4px;
                        font-size: 0.7rem;
                        font-weight: 600;
                      "
                      >NORMAL</span
                    >
                    <strong style="font-size: 0.9rem"
                      >Wilma Andersson (7B)</strong
                    >
                  </div>
                  <span
                    class="status-badge status-progress"
                    style="font-size: 0.7rem"
                    >Under investigation</span
                  >
                </div>
                <div
                  style="
                    font-size: 0.85rem;
                    color: var(--text);
                    margin-bottom: 0.5rem;
                  "
                >
                  <strong>Digital harassment</strong> - Cyberbullying via
                  Snapchat
                </div>
                <div
                  style="
                    font-size: 0.8rem;
                    color: var(--text-light);
                    margin-bottom: 0.75rem;
                  "
                >
                  Reported by: Maria Andersson ‚Ä¢ INC-2025-0039
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showIncident(7)"
                  >
                    View Case
                  </button>
                  <button
                    class="btn btn-sm btn-ghost"
                    onclick="showEhtDecisionModal(7, 'Wilma Andersson')"
                  >
                    üìù Record decision
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Meeting Actions -->
          <div style="display: flex; gap: 1rem; flex-wrap: wrap">
            <button class="btn btn-primary" onclick="completeEhtMeeting()">
              ‚úì Complete meeting and save decisions
            </button>
            <button class="btn btn-ghost" onclick="printEhtAgenda()">
              üñ®Ô∏è Print agenda
            </button>
          </div>
        </div>

        <!-- History Panel -->
        <div class="eht-panel" id="ehtPanelHistory" style="display: none">
          <div class="card">
            <div class="card-header">Timeigare EHT Meetings</div>
            <div class="card-body" style="padding: 0">
              <div
                style="
                  padding: 1rem;
                  border-bottom: 1px solid var(--border);
                  cursor: pointer;
                "
                onclick="showEhtMeetingDetails('2025-01-23')"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <strong style="font-size: 0.9rem"
                      >Thursday 23 januari 2025</strong
                    >
                    <div style="font-size: 0.8rem; color: var(--text-light)">
                      3 cases behandlade ‚Ä¢ 5 participants
                    </div>
                  </div>
                  <span style="color: var(--text-light)">‚Üí</span>
                </div>
              </div>
              <div
                style="
                  padding: 1rem;
                  border-bottom: 1px solid var(--border);
                  cursor: pointer;
                "
                onclick="showEhtMeetingDetails('2025-01-16')"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <strong style="font-size: 0.9rem"
                      >Thursday 16 januari 2025</strong
                    >
                    <div style="font-size: 0.8rem; color: var(--text-light)">
                      5 cases behandlade ‚Ä¢ 4 participants
                    </div>
                  </div>
                  <span style="color: var(--text-light)">‚Üí</span>
                </div>
              </div>
              <div
                style="padding: 1rem; cursor: pointer"
                onclick="showEhtMeetingDetails('2025-01-09')"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <strong style="font-size: 0.9rem"
                      >Thursday 9 januari 2025</strong
                    >
                    <div style="font-size: 0.8rem; color: var(--text-light)">
                      2 cases behandlade ‚Ä¢ 5 participants
                    </div>
                  </div>
                  <span style="color: var(--text-light)">‚Üí</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Panel -->
        <div class="eht-panel" id="ehtPanelSettings" style="display: none">
          <div class="card">
            <div class="card-header">EHT Settings</div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Meeting day</label>
                <select class="form-input">
                  <option>Monday</option>
                  <option>Tuesday</option>
                  <option>Wednesday</option>
                  <option selected>Thursday</option>
                  <option>Friday</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Meeting time</label>
                <input type="time" class="form-input" value="14:00" />
              </div>
              <div class="form-group">
                <label class="form-label">Location</label>
                <input
                  type="text"
                  class="form-input"
                  value="Conference Room B"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Standardparticipants</label>
                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                    margin-top: 0.5rem;
                  "
                >
                  <label
                    style="display: flex; align-items: center; gap: 0.5rem"
                  >
                    <input type="checkbox" checked /> Principal
                  </label>
                  <label
                    style="display: flex; align-items: center; gap: 0.5rem"
                  >
                    <input type="checkbox" checked /> Counselor
                  </label>
                  <label
                    style="display: flex; align-items: center; gap: 0.5rem"
                  >
                    <input type="checkbox" checked /> School Nurse
                  </label>
                  <label
                    style="display: flex; align-items: center; gap: 0.5rem"
                  >
                    <input type="checkbox" /> School Psychologist
                  </label>
                  <label
                    style="display: flex; align-items: center; gap: 0.5rem"
                  >
                    <input type="checkbox" checked /> Special Education Teacher
                  </label>
                </div>
              </div>
              <button class="btn btn-primary" onclick="saveEhtSettings()">
                Save settings
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== ADMIN PAGE ========== -->
      <div class="page" id="page-admin">
        <span class="back-link" onclick="showPage('dashboard')">‚Üê Back</span>

        <h2 class="section-title" style="margin-bottom: 1rem">
          Administration
        </h2>

        <!-- Admin Tabs -->
        <div
          style="
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
          "
        >
          <div
            class="admin-tab active"
            onclick="showAdminTab(this, 'users')"
            style="
              padding: 0.75rem 1.5rem;
              font-size: 0.85rem;
              font-weight: 500;
              color: var(--primary);
              cursor: pointer;
              border-bottom: 2px solid var(--primary);
              margin-bottom: -1px;
            "
          >
            Users
          </div>
          <div
            class="admin-tab"
            onclick="showAdminTab(this, 'gdpr')"
            style="
              padding: 0.75rem 1.5rem;
              font-size: 0.85rem;
              font-weight: 500;
              color: var(--text-light);
              cursor: pointer;
              border-bottom: 2px solid transparent;
              margin-bottom: -1px;
            "
          >
            GDPR & Retention
          </div>
          <div
            class="admin-tab"
            onclick="showAdminTab(this, 'statistics')"
            style="
              padding: 0.75rem 1.5rem;
              font-size: 0.85rem;
              font-weight: 500;
              color: var(--text-light);
              cursor: pointer;
              border-bottom: 2px solid transparent;
              margin-bottom: -1px;
            "
          >
            Statistics
          </div>
          <div
            class="admin-tab"
            onclick="showAdminTab(this, 'settings')"
            style="
              padding: 0.75rem 1.5rem;
              font-size: 0.85rem;
              font-weight: 500;
              color: var(--text-light);
              cursor: pointer;
              border-bottom: 2px solid transparent;
              margin-bottom: -1px;
            "
          >
            Settings
          </div>
        </div>

        <!-- Users Panel -->
        <div class="admin-panel active" id="panel-users">
          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">
              Users & Permissionser
              <button
                class="btn btn-primary btn-sm"
                onclick="showModal('addUserModal')"
              >
                + Add
              </button>
            </div>
            <div class="card-body" style="padding: 0; overflow-x: auto">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Permissions</th>
                    <th>Email</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="adminUserList">
                  <!-- Filled by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Rolebeskrivningar</div>
            <div class="card-body">
              <div style="display: grid; gap: 1rem">
                <div>
                  <strong style="font-size: 0.85rem">Teacher</strong>
                  <p style="font-size: 0.8rem; color: var(--text-light)">
                    Kan dokumentera incidenter. Ser endast sina egna
                    dokumentationer.
                  </p>
                </div>
                <div>
                  <strong style="font-size: 0.85rem">Mentor</strong>
                  <p style="font-size: 0.8rem; color: var(--text-light)">
                    Sees all cases for assigned class. Receives notifications.
                  </p>
                </div>
                <div>
                  <strong style="font-size: 0.85rem">Head of Year</strong>
                  <p style="font-size: 0.8rem; color: var(--text-light)">
                    Sees all cases for entire grade. Can escalate cases.
                  </p>
                </div>
                <div>
                  <strong style="font-size: 0.85rem">Counselor</strong>
                  <p style="font-size: 0.8rem; color: var(--text-light)">
                    Sees cases regarding harassment, mental health, welfare and
                    extremism. All classes.
                  </p>
                </div>
                <div>
                  <strong style="font-size: 0.85rem">Principal</strong>
                  <p style="font-size: 0.8rem; color: var(--text-light)">
                    Full access. Responsible for investigations under Chapter 6
                    and reports to authority.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GDPR Panel -->
        <div class="admin-panel" id="panel-gdpr" style="display: none">
          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">Retention Settings</div>
            <div class="card-body">
              <p
                style="
                  font-size: 0.85rem;
                  color: var(--text-light);
                  margin-bottom: 1rem;
                "
              >
                Specify how long documentation should be retained before
                automatic deletion.
              </p>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                "
              >
                <span style="font-size: 0.85rem"
                  >Standard bevarandetid (avslutade cases)</span
                >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <input
                    type="number"
                    value="12"
                    min="3"
                    max="60"
                    style="
                      width: 60px;
                      padding: 0.4rem;
                      border: 1px solid var(--border);
                      border-radius: 6px;
                      text-align: center;
                    "
                  />
                  <span style="font-size: 0.85rem">months</span>
                </div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                "
              >
                <span style="font-size: 0.85rem"
                  >Extended retention (serious cases)</span
                >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <input
                    type="number"
                    value="36"
                    min="12"
                    max="120"
                    style="
                      width: 60px;
                      padding: 0.4rem;
                      border: 1px solid var(--border);
                      border-radius: 6px;
                      text-align: center;
                    "
                  />
                  <span style="font-size: 0.85rem">months</span>
                </div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                "
              >
                <span style="font-size: 0.85rem"
                  >Automatisk gallring aktiv</span
                >
                <div
                  class="toggle-switch active"
                  onclick="this.classList.toggle('active')"
                  style="
                    position: relative;
                    width: 44px;
                    height: 24px;
                    background: var(--primary);
                    border-radius: 12px;
                    cursor: pointer;
                  "
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                "
              >
                <span style="font-size: 0.85rem">Reminder before deletion</span>
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <input
                    type="number"
                    value="30"
                    min="7"
                    max="90"
                    style="
                      width: 60px;
                      padding: 0.4rem;
                      border: 1px solid var(--border);
                      border-radius: 6px;
                      text-align: center;
                    "
                  />
                  <span style="font-size: 0.85rem">days</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">
              Data Export & Radering (GDPR Art. 15 & 17)
            </div>
            <div class="card-body">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                  align-items: center;
                "
              >
                <div>
                  <strong style="font-size: 0.85rem"
                    >Export student data</strong
                  >
                  <p style="font-size: 0.75rem; color: var(--text-light)">
                    Create data extract for data subject
                  </p>
                </div>
                <button
                  class="btn btn-sm btn-secondary"
                  onclick="showModal('exportModal')"
                >
                  Skapa utdrag
                </button>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  align-items: center;
                "
              >
                <div>
                  <strong style="font-size: 0.85rem">Radera elevdata</strong>
                  <p style="font-size: 0.75rem; color: var(--text-light)">
                    Permanent radering enligt Art. 17
                  </p>
                </div>
                <button
                  class="btn btn-sm"
                  style="background: var(--error); color: white"
                  onclick="showModal('deleteDataModal')"
                >
                  Delete data
                </button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">Cases approaching deletion</div>
            <div class="card-body">
              <div style="font-size: 0.85rem">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    padding: 0.5rem 0;
                    border-bottom: 1px solid var(--border);
                  "
                >
                  <span>INC-2024-0089 - Emma L. (Disruption)</span>
                  <span style="color: var(--warning)">Gallras om 15 days</span>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    padding: 0.5rem 0;
                    border-bottom: 1px solid var(--border);
                  "
                >
                  <span>INC-2024-0076 - Oscar N. (Absence)</span>
                  <span style="color: var(--warning)">Gallras om 22 days</span>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    padding: 0.5rem 0;
                  "
                >
                  <span>INC-2024-0065 - Liam K. (Vandalism)</span>
                  <span style="color: var(--warning)">Gallras om 28 days</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Access Log</div>
            <div class="card-body">
              <p
                style="
                  font-size: 0.8rem;
                  color: var(--text-light);
                  margin-bottom: 0.75rem;
                "
              >
                Traceability for who has read or modified documentation.
              </p>
              <div style="font-size: 0.8rem; color: var(--text-light)">
                <div
                  style="
                    padding: 0.4rem 0;
                    border-bottom: 1px solid var(--border);
                  "
                >
                  <strong>Maria Andersson</strong> √∂ppnade INC-2025-0042 ‚Ä¢ Today
                  10:32
                </div>
                <div
                  style="
                    padding: 0.4rem 0;
                    border-bottom: 1px solid var(--border);
                  "
                >
                  <strong>Lisa Bergstr√∂m</strong> lade till √•tg√§rd p√•
                  INC-2025-0041 ‚Ä¢ Today 09:15
                </div>
                <div style="padding: 0.4rem 0">
                  <strong>Peter Svensson</strong> eskalerade INC-2025-0040 ‚Ä¢
                  Ig√•r 14:22
                </div>
              </div>
              <button class="btn btn-sm btn-ghost" style="margin-top: 0.75rem">
                View full log ‚Üí
              </button>
            </div>
          </div>
        </div>

        <!-- Statistics Panel -->
        <div class="admin-panel" id="panel-statistics" style="display: none">
          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">
              Statistics 2024/2025
              <div style="display: flex; gap: 0.5rem">
                <button
                  class="btn btn-sm btn-ghost"
                  onclick="exportStats('excel')"
                >
                  üìä Export Excel
                </button>
                <button
                  class="btn btn-sm btn-ghost"
                  onclick="exportStats('pdf')"
                >
                  üìÑ Export PDF
                </button>
              </div>
            </div>
            <div class="card-body">
              <p
                style="
                  font-size: 0.85rem;
                  color: var(--text-light);
                  margin-bottom: 1rem;
                "
              >
                Statistics for equal treatment plan and systematic quality work
              </p>

              <!-- Summary Stats -->
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(4, 1fr);
                  gap: 1rem;
                  margin-bottom: 1.5rem;
                "
              >
                <div
                  style="
                    background: #f0fff4;
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div
                    style="font-size: 1.5rem; font-weight: 700; color: #22543d"
                  >
                    124
                  </div>
                  <div style="font-size: 0.75rem; color: #276749">
                    Total incidents
                  </div>
                </div>
                <div
                  style="
                    background: #ebf8ff;
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div
                    style="font-size: 1.5rem; font-weight: 700; color: #2b6cb0"
                  >
                    108
                  </div>
                  <div style="font-size: 0.75rem; color: #2c5282">
                    Closed cases
                  </div>
                </div>
                <div
                  style="
                    background: #fef3c7;
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div
                    style="font-size: 1.5rem; font-weight: 700; color: #92400e"
                  >
                    3.2 days
                  </div>
                  <div style="font-size: 0.75rem; color: #a16207">
                    Avg. handling time
                  </div>
                </div>
                <div
                  style="
                    background: #fee2e2;
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div
                    style="font-size: 1.5rem; font-weight: 700; color: #991b1b"
                  >
                    12
                  </div>
                  <div style="font-size: 0.75rem; color: #b91c1c">
                    Repeat students
                  </div>
                </div>
              </div>

              <!-- Category Distribution -->
              <div style="margin-bottom: 1.5rem">
                <div
                  style="
                    font-size: 0.85rem;
                    font-weight: 600;
                    margin-bottom: 0.75rem;
                  "
                >
                  Incidents by category
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem">
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <span style="width: 140px; font-size: 0.8rem"
                      >Disruptive behavior</span
                    >
                    <div
                      style="
                        flex: 1;
                        background: #e2e8f0;
                        height: 20px;
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        style="
                          width: 35%;
                          height: 100%;
                          background: var(--primary);
                        "
                      ></div>
                    </div>
                    <span
                      style="width: 40px; font-size: 0.8rem; text-align: right"
                      >43</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <span style="width: 140px; font-size: 0.8rem"
                      >Harassment</span
                    >
                    <div
                      style="
                        flex: 1;
                        background: #e2e8f0;
                        height: 20px;
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        style="width: 22%; height: 100%; background: #e53e3e"
                      ></div>
                    </div>
                    <span
                      style="width: 40px; font-size: 0.8rem; text-align: right"
                      >27</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <span style="width: 140px; font-size: 0.8rem"
                      >Violence & Threats</span
                    >
                    <div
                      style="
                        flex: 1;
                        background: #e2e8f0;
                        height: 20px;
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        style="width: 15%; height: 100%; background: #dd6b20"
                      ></div>
                    </div>
                    <span
                      style="width: 40px; font-size: 0.8rem; text-align: right"
                      >19</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <span style="width: 140px; font-size: 0.8rem">Absence</span>
                    <div
                      style="
                        flex: 1;
                        background: #e2e8f0;
                        height: 20px;
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        style="width: 12%; height: 100%; background: #38a169"
                      ></div>
                    </div>
                    <span
                      style="width: 40px; font-size: 0.8rem; text-align: right"
                      >15</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <span style="width: 140px; font-size: 0.8rem">Other</span>
                    <div
                      style="
                        flex: 1;
                        background: #e2e8f0;
                        height: 20px;
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        style="width: 16%; height: 100%; background: #718096"
                      ></div>
                    </div>
                    <span
                      style="width: 40px; font-size: 0.8rem; text-align: right"
                      >20</span
                    >
                  </div>
                </div>
              </div>

              <!-- Class Distribution -->
              <div>
                <div
                  style="
                    font-size: 0.85rem;
                    font-weight: 600;
                    margin-bottom: 0.75rem;
                  "
                >
                  Incidents by class
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                    gap: 0.5rem;
                  "
                >
                  <div
                    style="
                      background: #f7fafc;
                      padding: 0.5rem;
                      border-radius: 6px;
                      text-align: center;
                      border: 1px solid var(--border);
                    "
                  >
                    <div style="font-weight: 600; font-size: 0.9rem">7A</div>
                    <div style="font-size: 0.75rem; color: var(--text-light)">
                      12
                    </div>
                  </div>
                  <div
                    style="
                      background: #f7fafc;
                      padding: 0.5rem;
                      border-radius: 6px;
                      text-align: center;
                      border: 1px solid var(--border);
                    "
                  >
                    <div style="font-weight: 600; font-size: 0.9rem">7B</div>
                    <div style="font-size: 0.75rem; color: var(--text-light)">
                      8
                    </div>
                  </div>
                  <div
                    style="
                      background: #fee2e2;
                      padding: 0.5rem;
                      border-radius: 6px;
                      text-align: center;
                      border: 1px solid #feb2b2;
                    "
                  >
                    <div
                      style="
                        font-weight: 600;
                        font-size: 0.9rem;
                        color: #c53030;
                      "
                    >
                      8A
                    </div>
                    <div style="font-size: 0.75rem; color: #c53030">21</div>
                  </div>
                  <div
                    style="
                      background: #fef3c7;
                      padding: 0.5rem;
                      border-radius: 6px;
                      text-align: center;
                      border: 1px solid #fcd34d;
                    "
                  >
                    <div
                      style="
                        font-weight: 600;
                        font-size: 0.9rem;
                        color: #92400e;
                      "
                    >
                      8B
                    </div>
                    <div style="font-size: 0.75rem; color: #92400e">18</div>
                  </div>
                  <div
                    style="
                      background: #f7fafc;
                      padding: 0.5rem;
                      border-radius: 6px;
                      text-align: center;
                      border: 1px solid var(--border);
                    "
                  >
                    <div style="font-weight: 600; font-size: 0.9rem">9A</div>
                    <div style="font-size: 0.75rem; color: var(--text-light)">
                      14
                    </div>
                  </div>
                  <div
                    style="
                      background: #f7fafc;
                      padding: 0.5rem;
                      border-radius: 6px;
                      text-align: center;
                      border: 1px solid var(--border);
                    "
                  >
                    <div style="font-weight: 600; font-size: 0.9rem">9B</div>
                    <div style="font-size: 0.75rem; color: var(--text-light)">
                      11
                    </div>
                  </div>
                </div>
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-light);
                    margin-top: 0.5rem;
                  "
                >
                  Red = above threshold (20), Yellow = near threshold
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Panel -->
        <div class="admin-panel" id="panel-settings" style="display: none">
          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">Thresholds</div>
            <div class="card-body">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                "
              >
                <span style="font-size: 0.85rem"
                  >Flag student after number of incidents (30 days)</span
                >
                <input
                  type="number"
                  value="3"
                  min="2"
                  max="10"
                  style="
                    width: 60px;
                    padding: 0.4rem;
                    border: 1px solid var(--border);
                    border-radius: 6px;
                    text-align: center;
                  "
                />
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  align-items: center;
                "
              >
                <span style="font-size: 0.85rem"
                  >Auto-escalate to principal at</span
                >
                <select
                  class="form-select"
                  style="width: auto; min-width: 180px"
                >
                  <option>Serious and higher</option>
                  <option>Endast Critical</option>
                  <option selected>All harassment cases</option>
                  <option>Ingen automatisk</option>
                </select>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">Notifieringar</div>
            <div class="card-body">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                  align-items: center;
                "
              >
                <span style="font-size: 0.85rem"
                  >Notifiera rektor vid akuta cases</span
                >
                <div
                  class="toggle-switch active"
                  onclick="this.classList.toggle('active')"
                  style="
                    position: relative;
                    width: 44px;
                    height: 24px;
                    background: var(--primary);
                    border-radius: 12px;
                    cursor: pointer;
                  "
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  border-bottom: 1px solid var(--border);
                  align-items: center;
                "
              >
                <span style="font-size: 0.85rem"
                  >Notifiera mentor vid cases i klassen</span
                >
                <div
                  class="toggle-switch active"
                  onclick="this.classList.toggle('active')"
                  style="
                    position: relative;
                    width: 44px;
                    height: 24px;
                    background: var(--primary);
                    border-radius: 12px;
                    cursor: pointer;
                  "
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.75rem 0;
                  align-items: center;
                "
              >
                <span style="font-size: 0.85rem"
                  >Notifiera kurator vid oroscases</span
                >
                <div
                  class="toggle-switch active"
                  onclick="this.classList.toggle('active')"
                  style="
                    position: relative;
                    width: 44px;
                    height: 24px;
                    background: var(--primary);
                    border-radius: 12px;
                    cursor: pointer;
                  "
                ></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Skolinformation</div>
            <div class="card-body">
              <div class="form-group" style="margin-bottom: 0.75rem">
                <label class="form-label">Skolans namn</label>
                <input type="text" class="form-input" value="Bj√∂rkskolan" />
              </div>
              <div class="form-group" style="margin-bottom: 0.75rem">
                <label class="form-label">Huvudman</label>
                <input
                  type="text"
                  class="form-input"
                  value="J√∂nk√∂pings kommun"
                />
              </div>
              <div class="form-group" style="margin-bottom: 0">
                <label class="form-label">Principal</label>
                <input type="text" class="form-input" value="Peter Svensson" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- ========== MODALS ========== -->

    <!-- Add Action Modal -->
    <div class="modal-overlay" id="addActionModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Add Action</h3>
          <button class="modal-close" onclick="closeModal('addActionModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Select action</label>
            <select class="form-select" id="actionSelect">
              <option value="">-- Select --</option>
              <option value="verbal">Verbal warning</option>
              <option value="talk">Conversations med elev</option>
              <option value="parentcall">Phone call with guardians</option>
              <option value="parentmeeting">Meeting with guardians</option>
              <option value="counselor">Referral to counselor</option>
              <option value="principal">Conversations med rektor</option>
              <option value="warning">Written warning</option>
              <option value="contract">Beteendeavtal</option>
              <option value="relocation">Temporary relocation</option>
              <option value="suspension">Suspension</option>
              <option value="police">Police Report</option>
              <option value="welfare">Welfare Report</option>
              <option value="other">Other action...</option>
            </select>
          </div>
          <div class="form-group" id="customActionGroup" style="display: none">
            <label class="form-label">Describe action</label>
            <input
              type="text"
              class="form-input"
              placeholder="T.ex. Medlingssamtal"
              id="customActionInput"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Anteckning (valfritt)</label>
            <textarea
              class="form-textarea"
              placeholder="Add notering..."
              id="actionNote"
              style="min-height: 60px"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('addActionModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="addAction()">Add</button>
        </div>
      </div>
    </div>

    <!-- Escalate Modal -->
    <div class="modal-overlay" id="escalateModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Escalate case</h3>
          <button class="modal-close" onclick="closeModal('escalateModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <p
            style="
              margin-bottom: 1rem;
              font-size: 0.9rem;
              color: var(--text-light);
            "
          >
            Select who should be notified:
          </p>
          <div style="display: flex; flex-direction: column; gap: 0.5rem">
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
            >
              <input type="checkbox" checked />
              <div>
                <strong style="font-size: 0.9rem">Principal</strong>
                <span
                  style="
                    font-size: 0.7rem;
                    background: var(--error);
                    color: white;
                    padding: 0.1rem 0.4rem;
                    border-radius: 3px;
                    margin-left: 0.5rem;
                  "
                  >Obligatorisk</span
                >
                <p style="font-size: 0.8rem; color: var(--text-light)">
                  Notified for harassment cases
                </p>
              </div>
            </label>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
            >
              <input type="checkbox" />
              <div>
                <strong style="font-size: 0.9rem">Counselor</strong>
                <p style="font-size: 0.8rem; color: var(--text-light)">
                  Student support and follow-up
                </p>
              </div>
            </label>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
            >
              <input type="checkbox" />
              <div>
                <strong style="font-size: 0.9rem">Guardians</strong>
                <p style="font-size: 0.8rem; color: var(--text-light)">
                  Contacted for serious incidents
                </p>
              </div>
            </label>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
            >
              <input type="checkbox" />
              <div>
                <strong style="font-size: 0.9rem">Huvudman</strong>
                <p style="font-size: 0.8rem; color: var(--text-light)">
                  Report under Chapter 6 Section 10 Education Act
                </p>
              </div>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('escalateModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-primary"
            onclick="
              closeModal('escalateModal');
              showToast('Case escalated', 'success');
            "
          >
            Send
          </button>
        </div>
      </div>
    </div>

    <!-- Document Modal -->
    <div class="modal-overlay" id="documentModal">
      <div class="modal wide">
        <div class="modal-header">
          <h3 class="modal-title">Create document</h3>
          <button class="modal-close" onclick="closeModal('documentModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem"
          >
            <div
              style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
              onclick="generateDoc('welfare')"
            >
              <strong>üèõÔ∏è Welfare Report</strong>
              <p style="font-size: 0.75rem; color: var(--text-light)">
                14 kap. 1 ¬ß SoL
              </p>
            </div>
            <div
              style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
              onclick="generateDoc('police')"
            >
              <strong>üëÆ Police Report</strong>
              <p style="font-size: 0.75rem; color: var(--text-light)">
                6a kap. 10 ¬ß Education Act
              </p>
            </div>
            <div
              style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
              onclick="generateDoc('investigation')"
            >
              <strong>üîç Harassment investigation</strong>
              <p style="font-size: 0.75rem; color: var(--text-light)">
                6 kap. 10 ¬ß Education Act
              </p>
            </div>
            <div
              style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
              onclick="generateDoc('warning')"
            >
              <strong>‚ö†Ô∏è Written warning</strong>
              <p style="font-size: 0.75rem; color: var(--text-light)">
                5 kap. 11 ¬ß Education Act
              </p>
            </div>
            <div
              style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
              onclick="generateDoc('parent')"
            >
              <strong>‚úâÔ∏è Letter to guardians</strong>
              <p style="font-size: 0.75rem; color: var(--text-light)">
                Information about incident
              </p>
            </div>
            <div
              style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
              "
              onclick="generateDoc('plan')"
            >
              <strong>üìã Action program</strong>
              <p style="font-size: 0.75rem; color: var(--text-light)">
                3 kap. 9 ¬ß Education Act
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('documentModal')"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm Exit Modal -->
    <div class="modal-overlay" id="confirmExitModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">Cancel dokumentation?</h3>
          <button class="modal-close" onclick="closeModal('confirmExitModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <p style="font-size: 0.9rem">
            Are you sure you want to cancel? All information you entered will be
            lost.
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('confirmExitModal')"
          >
            Continue writing
          </button>
          <button
            class="btn btn-primary"
            onclick="
              closeModal('confirmExitModal');
              resetWizard();
              showPage('dashboard');
            "
          >
            Yes, cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Edit user</h3>
          <button class="modal-close" onclick="closeModal('editUserModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Name</label>
            <input
              type="text"
              class="form-input"
              value="Anna Lindstr√∂m"
              id="editUserName"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select class="form-select" id="editUserRole">
              <option value="teacher">Teacher</option>
              <option value="mentor" selected>Mentor</option>
              <option value="headofyear">Head of Year</option>
              <option value="counselor">Counselor</option>
              <option value="principal">Principal</option>
              <option value="admin">Administrator</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Permissions for classes/grades</label>
            <input
              type="text"
              class="form-input"
              value="8B"
              placeholder="E.g. 8B, 9A"
              id="editUserAccess"
            />
            <div class="form-help">
              Separate multiple with comma. Leave empty for all.
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input
              type="email"
              class="form-input"
              value="anna.lindstrom@skola.se"
              id="editUserEmail"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('editUserModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-primary"
            onclick="
              closeModal('editUserModal');
              showToast('Users uppdaterad', 'success');
            "
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Export Data Modal (GDPR Art. 15) -->
    <div class="modal-overlay" id="exportModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Data Export (GDPR Art. 15)</h3>
          <button class="modal-close" onclick="closeModal('exportModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Elevens namn</label>
            <input
              type="text"
              class="form-input"
              placeholder="Search student..."
              id="exportStudentName"
            />
          </div>
          <div class="guidance-box" style="margin-top: 1rem">
            <div class="guidance-title">‚ÑπÔ∏è Information</div>
            <div class="guidance-text">
              The data export contains all documentation about the specified
              student:
              <ul
                style="
                  margin-top: 0.5rem;
                  margin-left: 1.25rem;
                  font-size: 0.8rem;
                "
              >
                <li>All dokumenterade incidenter</li>
                <li>Actions taken</li>
                <li>Communication with guardians</li>
                <li>Access Log (vem som sett uppgifterna)</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('exportModal')">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            onclick="
              closeModal('exportModal');
              showToast('Data Export skapas...', 'success');
            "
          >
            Exportera
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Data Modal (GDPR Art. 17) -->
    <div class="modal-overlay" id="deleteDataModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Radera elevdata (GDPR Art. 17)</h3>
          <button class="modal-close" onclick="closeModal('deleteDataModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="guidance-box alert" style="margin-bottom: 1rem">
            <div class="guidance-title">‚ö†Ô∏è Varning</div>
            <div class="guidance-text">
              Deletion of personal data is <strong>permanent</strong> and cannot
              be undone. Some data may need to be retained by law (e.g.
              documentation of disciplinary actions).
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Elevens namn</label>
            <input
              type="text"
              class="form-input"
              placeholder="Search student..."
              id="deleteStudentName"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Anledning till radering</label>
            <select class="form-select">
              <option value="">-- Select --</option>
              <option>Request from data subject (Art. 17)</option>
              <option>Retention period has expired</option>
              <option>Felaktig registrering</option>
              <option>Annan anledning</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('deleteDataModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-primary"
            style="background: var(--error)"
            onclick="
              closeModal('deleteDataModal');
              showToast('Data raderad', 'success');
            "
          >
            Radera permanent
          </button>
        </div>
      </div>
    </div>

    <!-- EHT Decision Modal -->
    <div class="modal-overlay" id="ehtDecisionModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">üìã EHT Decision</h3>
          <button class="modal-close" onclick="closeModal('ehtDecisionModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div
            style="
              background: #f7fafc;
              padding: 0.75rem;
              border-radius: 8px;
              margin-bottom: 1rem;
            "
          >
            <strong id="ehtDecisionStudent">Erik Johansson (8B)</strong>
            <div
              style="font-size: 0.8rem; color: var(--text-light)"
              id="ehtDecisionCase"
            >
              INC-2025-0042
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Decision / Action</label>
            <textarea
              class="form-textarea"
              id="ehtDecisionText"
              placeholder="E.g. Counselor takes over. Support meetings 1x/week. Contact with child psychiatry recommended."
              style="min-height: 100px"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Responsible for follow-up</label>
            <select class="form-select" id="ehtDecisionResponsible">
              <option value="">-- Select responsible --</option>
              <option value="maria">Maria Andersson (Principal)</option>
              <option value="anna">Anna Lindstr√∂m (Mentor)</option>
              <option value="lisa" selected>Lisa Bergstr√∂m (Counselor)</option>
              <option value="johan">Johan Eriksson (Head of Year)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Next follow-up</label>
            <input
              type="date"
              class="form-input"
              id="ehtDecisionFollowup"
              value="2025-02-13"
            />
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem">
              <input type="checkbox" id="ehtDecisionAddToTimeline" checked />
              <span style="font-size: 0.85rem">Add to case timeline</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('ehtDecisionModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveEhtDecision()">
            Save beslut
          </button>
        </div>
      </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal-overlay" id="addNoteModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">üìù Add Note</h3>
          <button class="modal-close" onclick="closeModal('addNoteModal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Note</label>
            <textarea
              class="form-textarea"
              id="caseNoteText"
              placeholder="E.g. Tried calling parents but no answer. Left message."
              style="min-height: 120px"
            ></textarea>
          </div>
          <p style="font-size: 0.75rem; color: var(--text-light)">
            The note will be visible to everyone with access to the case.
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('addNoteModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveCaseNote()">
            Save note
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
      // ==================== DATA ====================
      const categories = [
        {
          id: "violence",
          icon: "üëä",
          name: "Violence & Threats",
          subcats: [
            "Physical violence against student",
            "Physical violence against staff",
            "Verbal threats",
            "Fighting",
            "With weapon",
            "Other",
          ],
          guidance: {
            type: "alert",
            title: "‚ö†Ô∏è Important information",
            text: "For violence or serious threats, police report should be considered. Always inform principal for serious incidents. When crime is suspected, police report should be made.",
            links: [
              {
                text: "üëÆ Police Report",
                url: "https://polisen.se/utsatt-for-brott/polisanmalan/",
              },
            ],
          },
        },
        {
          id: "bullying",
          icon: "üò¢",
          name: "Bullying & Harassment",
          subcats: [
            "Verbal bullying",
            "Social exclusion",
            "Psychological bullying",
            "Discrimination",
            "Racism",
            "Sexual harassment",
            "Other",
          ],
          guidance: {
            type: "warning",
            title: "‚ÑπÔ∏è Legal requirement",
            text: "Harassment must always be reported to the principal who is responsible for prompt investigation under Chapter 6 Section 10 Education Act.",
            links: [
              {
                text: "‚öñÔ∏è Children and Student Ombudsman",
                url: "https://beo.skolinspektionen.se/",
              },
            ],
          },
        },
        {
          id: "disruption",
          icon: "üì¢",
          name: "Disruption",
          subcats: [
            "Classroom disruption",
            "Refuses to follow instructions",
            "Inappropriate language",
            "Disrespect",
            "Repeated acting out",
            "Other",
          ],
          guidance: {
            type: "info",
            title: "üí° Tip",
            text: "For repeated disruptions, disciplinary measures under Chapter 5 Education Act may apply. Document incidents and actions taken.",
          },
        },
        {
          id: "absence",
          icon: "üö∂",
          name: "Absence",
          subcats: [
            "Unauthorized absence",
            "Repeated tardiness",
            "Leaves class",
            "Truancy",
            "Home-bound student",
            "Other",
          ],
          guidance: {
            type: "info",
            title: "üí° Remember",
            text: "For repeated or prolonged absence, investigation should be conducted. Contact guardians and consider collaboration with student health team.",
          },
        },
        {
          id: "substance",
          icon: "üö≠",
          name: "Drugs & Tobacco",
          subcats: [
            "Suspected influence",
            "Drug possession",
            "Selling/dealing",
            "Alcohol",
            "Tobacco/snus/vape",
            "Other",
          ],
          guidance: {
            type: "alert",
            title: "‚ö†Ô∏è Important information",
            text: "Drug possession or sale is a crime. Contact principal who assesses if police report should be made. Also consider welfare report.",
            links: [
              {
                text: "üëÆ Police Report",
                url: "https://polisen.se/utsatt-for-brott/polisanmalan/",
              },
              {
                text: "üèõÔ∏è Social Services",
                url: "https://www.socialstyrelsen.se/",
              },
            ],
          },
        },
        {
          id: "welfare",
          icon: "üíô",
          name: "Welfare Concern",
          subcats: [
            "Sadness/depression",
            "Anxiety",
            "Self-harm behavior",
            "Suicidal thoughts",
            "Eating disorder",
            "Social isolation",
            "Suspected violence/abuse at home",
            "Other",
          ],
          guidance: {
            type: "alert",
            title: "üö® Reporting obligation",
            text: "If you suspect a child is being harmed, you are obligated to make a welfare report to social services under Chapter 14 Section 1 of the Social Services Act. This applies immediately.",
            links: [
              {
                text: "üèõÔ∏è Welfare Report",
                url: "https://www.socialstyrelsen.se/",
              },
              { text: "üè• 1177", url: "https://www.1177.se/" },
            ],
          },
        },
        {
          id: "theft",
          icon: "üîí",
          name: "Theft & Vandalism",
          subcats: ["Theft", "Vandalism", "Graffiti", "Other"],
          guidance: {
            type: "warning",
            title: "‚ÑπÔ∏è Remember",
            text: "Theft and vandalism may be criminal acts. Consider police report and document the damage.",
          },
        },
        {
          id: "digital",
          icon: "üì±",
          name: "Digital Incident",
          subcats: [
            "Cyberbullying",
            "Online threats",
            "Sharing images",
            "Inappropriate content",
            "Intrusion/hacking",
            "Other",
          ],
          guidance: {
            type: "warning",
            title: "‚ÑπÔ∏è Important information",
            text: "Digital harassment is covered by the same rules as physical. Sharing privacy-violating images may be a crime. Save evidence (screenshots).",
          },
        },
        {
          id: "extremism",
          icon: "üè¥",
          name: "Extremism",
          subcats: [
            "Radicalization",
            "Hate speech",
            "Extremist symbols/material",
            "Recruitment",
            "Violence-promoting expressions",
            "Online radicalization",
            "Other",
          ],
          guidance: {
            type: "alert",
            title: "üö® Important information",
            text: "For signs of radicalization or extremism, always inform principal and counselor. Consider contact with social services and police. Document carefully.",
            links: [
              {
                text: "üìû CVE (Center against violent extremism)",
                url: "https://www.cve.se/",
              },
              {
                text: "üèõÔ∏è Social Services",
                url: "https://www.socialstyrelsen.se/",
              },
            ],
          },
        },
        {
          id: "gang",
          icon: "üë•",
          name: "Gang Activity",
          subcats: [
            "Suspected gang affiliation",
            "Recruitment attempts",
            "Gang symbols/clothing",
            "Threats from criminals",
            "Extortion",
            "Criminal activity at school",
            "Other",
          ],
          guidance: {
            type: "alert",
            title: "üö® Important information",
            text: "If gang activity is suspected, principal must always be informed. Collaborate with police, social services and SSP. Consider welfare report.",
            links: [
              { text: "üëÆ Police", url: "https://polisen.se/" },
              {
                text: "üèõÔ∏è Social Services",
                url: "https://www.socialstyrelsen.se/",
              },
            ],
          },
        },
        {
          id: "other",
          icon: "‚ö†Ô∏è",
          name: "Other",
          subcats: [
            "Accident/injury",
            "Property issues",
            "Parent-related",
            "Other",
          ],
          guidance: {
            type: "info",
            title: "üí° Tip",
            text: "Describe the incident as detailed as possible so appropriate actions can be taken.",
          },
        },
      ];

      const incidents = [
        {
          id: 1,
          student: "Oscar Nilsson",
          class: "9A",
          category: "welfare",
          subcat: "Self-harm behavior",
          severity: "critical",
          status: "open",
          date: "2025-01-25",
          purpose: "welfare",
          flags: ["legal"],
          description:
            "Counselor uppt√§ckte s√•r p√• elevens armar. Eleven medgav sj√§lvskadebeteende sedan n√•gra veckor tillbaka.",
          actions:
            "Critical samtal med kurator genomf√∂rt. Contact with Guardians.",
          reporter: "Lisa Bergstr√∂m",
        },
        {
          id: 2,
          student: "Erik Johansson",
          class: "8B",
          category: "bullying",
          subcat: "Verbal mobbning",
          severity: "serious",
          status: "progress",
          date: "2025-01-24",
          purpose: "harassment",
          flags: ["threshold"],
          description:
            "Erik har vid upprepade tillf√§llen riktat kr√§nkande kommentarer mot Maja. Situationen eskalerade idag efter lunchen.",
          actions:
            "Conversations med Erik genomf√∂rt. Mentor och v√•rdnadshavare notified.",
          reporter: "Maria Andersson",
          victim: "Maja Svensson",
        },
        {
          id: 3,
          student: "Kevin Lindqvist",
          class: "9B",
          category: "gang",
          subcat: "Suspected gang affiliation",
          severity: "serious",
          status: "progress",
          date: "2025-01-24",
          purpose: "safety",
          flags: [],
          description:
            "Eleven har b√∂rjat b√§ra kl√§der och symboler associerade med k√§nt kriminellt n√§tverk. F√∂r√§ndrat beteende senaste m√•naden.",
          actions: "Conversations med kurator bokat. Principal notified.",
          reporter: "Johan Eriksson",
        },
        {
          id: 4,
          student: "Emma Lindberg",
          class: "7A",
          category: "disruption",
          subcat: "Classroom disruption",
          severity: "moderate",
          status: "action",
          date: "2025-01-23",
          purpose: "disciplinary",
          flags: [],
          description:
            "Upprepade st√∂rningar under matematiklektionen. Refuses to follow instructions.",
          actions: "Conversations med elev. Mentor notified.",
          reporter: "Maria Andersson",
        },
        {
          id: 5,
          student: "Adam Svensson",
          class: "8A",
          category: "extremism",
          subcat: "Hate speech",
          severity: "serious",
          status: "progress",
          date: "2025-01-23",
          purpose: "safety",
          flags: [],
          description:
            "Eleven har vid flera tillf√§llen uttryckt sig rasistiskt och delat extremistiskt material i klassgruppen p√• sociala medier.",
          actions:
            "Principal och kurator notified. Conversations med elev planerat.",
          reporter: "Anna Lindstr√∂m",
        },
        {
          id: 6,
          student: "Liam Karlsson",
          class: "9C",
          category: "absence",
          subcat: "Unauthorized absence",
          severity: "minor",
          status: "closed",
          date: "2025-01-22",
          purpose: "quality",
          flags: [],
          description: "Unauthorized absence tre days i rad.",
          actions: "Contact with Guardians. Eleven tillbaka i skolan.",
          reporter: "Peter Svensson",
        },
        {
          id: 7,
          student: "Wilma Andersson",
          class: "7B",
          category: "digital",
          subcat: "Cyberbullying",
          severity: "serious",
          status: "progress",
          date: "2025-01-22",
          purpose: "harassment",
          flags: [],
          description:
            "Kr√§nkande bilder och kommentarer har spridits om eleven i en Snapchat-grupp.",
          actions: "Counselor kontaktad. Investigation started.",
          reporter: "Maria Andersson",
          victim: "Wilma Andersson",
        },
        {
          id: 8,
          student: "Lucas Berg",
          class: "8B",
          category: "substance",
          subcat: "Tobacco/snus/vape",
          severity: "moderate",
          status: "followup",
          date: "2025-01-21",
          purpose: "disciplinary",
          flags: [],
          description: "Ertappad med e-cigarett p√• skolg√•rden.",
          actions:
            "E-cigarett omh√§ndertagen. Conversations med elev. Guardians notified.",
          reporter: "Johan Eriksson",
        },
      ];

      const users = [
        {
          name: "Maria Andersson",
          role: "principal",
          access: ["All"],
          email: "maria.andersson@skola.se",
        },
        {
          name: "Anna Lindstr√∂m",
          role: "mentor",
          access: ["8B"],
          email: "anna.lindstrom@skola.se",
        },
        {
          name: "Johan Eriksson",
          role: "headofyear",
          access: ["Grade 7"],
          email: "johan.eriksson@skola.se",
        },
        {
          name: "Lisa Bergstr√∂m",
          role: "counselor",
          access: ["All"],
          email: "lisa.bergstrom@skola.se",
        },
        {
          name: "Peter Svensson",
          role: "teacher",
          access: [],
          email: "peter.svensson@skola.se",
        },
      ];

      const roleNames = {
        teacher: "Teacher",
        mentor: "Mentor",
        headofyear: "Head of Year",
        counselor: "Counselor",
        principal: "Principal",
        admin: "Administrator",
      };

      const statusNames = {
        open: "Ny",
        progress: "Under investigation",
        action: "Action in progress",
        followup: "Follow-up",
        closed: "Closed",
      };

      const severityNames = {
        critical: "Critical",
        serious: "Serious",
        moderate: "Moderate",
        minor: "Mindre",
      };

      const purposeNames = {
        disciplinary: "Disciplinary Action",
        harassment: "Harassment / Investigation",
        safety: "Safety Incident",
        welfare: "Welfare Concern",
        quality: "Systematic Quality Work",
      };

      const legalBasis = {
        disciplinary: "5 kap. Education Act",
        harassment: "6 kap. 10 ¬ß Education Act",
        safety: "Work Environment Act",
        welfare: "14 kap. 1 ¬ß SoL",
        quality: "4 kap. Education Act",
      };

      const retentionMonths = {
        disciplinary: 12,
        harassment: 36,
        safety: 24,
        welfare: 36,
        quality: 12,
      };

      // ==================== STATE ====================
      let currentRole = "principal";
      let currentStep = 1;
      let selectedCategory = null;
      let selectedSubcats = [];
      let selectedSeverity = null;
      let currentIncident = null;

      // ==================== INIT ====================
      document.addEventListener("DOMContentLoaded", function () {
        renderCategoryGrid();
        changeRole("teacher");
        document.getElementById("inputDate").value = new Date()
          .toISOString()
          .split("T")[0];

        // Action select change handler
        document
          .getElementById("actionSelect")
          .addEventListener("change", function () {
            document.getElementById("customActionGroup").style.display =
              this.value === "other" ? "block" : "none";
          });
      });

      // ==================== NAVIGATION ====================
      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById("page-" + pageId).classList.add("active");
        window.scrollTo(0, 0);

        if (pageId === "list") renderFullList();
        if (pageId === "dashboard") renderDashboard();
        if (pageId === "admin") renderAdminUsers();
      }

      // ==================== ROLE MANAGEMENT ====================
      function changeRole(role) {
        currentRole = role;

        const showAlerts = ["counselor", "principal", "admin"].includes(role);
        const showWarning = ["mentor", "headofyear"].includes(role);
        const showStats = ["principal", "admin"].includes(role);
        const showAdmin = ["principal", "admin"].includes(role);
        const showRetention = ["principal", "admin"].includes(role);
        const showEht = ["counselor", "principal", "admin"].includes(role);

        document
          .getElementById("alertBanner")
          .classList.toggle("hidden", !showAlerts);
        document
          .getElementById("warningBanner")
          .classList.toggle("hidden", !showWarning);
        document
          .getElementById("statsRow")
          .classList.toggle("hidden", !showStats);
        document
          .getElementById("adminLink")
          .classList.toggle("hidden", !showAdmin);
        document
          .getElementById("retentionBanner")
          .classList.toggle("hidden", !showRetention);
        document.getElementById("ehtLink").classList.toggle("hidden", !showEht);

        // Update titles
        const titles = {
          teacher: { title: "My Cases", sub: "You have 2 open cases" },
          mentor: { title: "Cases in 8B", sub: "Your class has 3 open cases" },
          headofyear: {
            title: "Cases in Grade 7",
            sub: "The grade has 5 open cases",
          },
          counselor: {
            title: "My Cases",
            sub: "You have 4 cases requiring follow-up",
          },
          principal: { title: "All Cases", sub: "8 open cases at the school" },
          admin: { title: "All Cases", sub: "8 open cases at the school" },
        };

        document.getElementById("incidentListTitle").textContent =
          titles[role].title;
        document.getElementById("listPageTitle").textContent =
          titles[role].title;
        document.getElementById("dashboardSubtitle").textContent =
          titles[role].sub;

        renderDashboard();
        showToast("Visar som " + roleNames[role]);
      }

      // ==================== RENDER FUNCTIONS ====================
      function renderDashboard() {
        const filtered = filterIncidentsByRole(incidents);
        const recent = filtered.slice(0, 5);
        renderIncidentList(recent, "dashboardIncidents");
      }

      function renderFullList() {
        filterIncidents();
      }

      function filterIncidentsByRole(list) {
        if (["principal", "admin"].includes(currentRole)) return list;
        if (currentRole === "teacher")
          return list.filter((i) => i.reporter === "Maria Andersson");
        if (currentRole === "mentor")
          return list.filter((i) => i.class === "8B");
        if (currentRole === "headofyear")
          return list.filter((i) => i.class.includes("7"));
        if (currentRole === "counselor")
          return list.filter((i) =>
            ["bullying", "welfare", "extremism", "gang"].includes(i.category),
          );
        return list;
      }

      function filterIncidents() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const cat = document.getElementById("categoryFilter").value;
        const status = document.getElementById("statusFilter").value;
        const severity = document.getElementById("severityFilter").value;

        let filtered = filterIncidentsByRole(incidents);

        if (search) {
          filtered = filtered.filter(
            (i) =>
              i.student.toLowerCase().includes(search) ||
              i.class.toLowerCase().includes(search),
          );
        }
        if (cat) filtered = filtered.filter((i) => i.category === cat);
        if (status) filtered = filtered.filter((i) => i.status === status);
        if (severity)
          filtered = filtered.filter((i) => i.severity === severity);

        renderIncidentList(filtered, "fullIncidentList");
      }

      function renderIncidentList(list, containerId) {
        const container = document.getElementById(containerId);
        if (list.length === 0) {
          container.innerHTML =
            '<div style="padding:2rem;text-align:center;color:var(--text-light);">Inga cases att visa</div>';
          return;
        }

        container.innerHTML = list
          .map((inc) => {
            const cat = categories.find((c) => c.id === inc.category);
            const urgentClass = inc.flags.includes("legal")
              ? "urgent"
              : inc.flags.includes("threshold")
                ? "flagged"
                : "";
            const flagsHtml = inc.flags
              .map((f) => {
                if (f === "legal")
                  return '<span class="badge badge-legal">Welfare Report</span>';
                if (f === "threshold")
                  return '<span class="badge badge-threshold">Upprepade</span>';
                return "";
              })
              .join("");

            return `
                    <div class="incident-item ${urgentClass}" onclick="showIncident(${inc.id})">
                        <span class="severity-dot ${inc.severity}"></span>
                        <div class="incident-info">
                            <div class="incident-title">
                                ${inc.student} ${flagsHtml}
                            </div>
                            <div class="incident-meta">${cat.icon} ${cat.name} ‚Ä¢ ${inc.class} ‚Ä¢ ${inc.date}</div>
                        </div>
                        <span class="status-badge status-${inc.status}">${statusNames[inc.status]}</span>
                    </div>
                `;
          })
          .join("");
      }

      function showIncident(id) {
        currentIncident = incidents.find((i) => i.id === id);
        const cat = categories.find((c) => c.id === currentIncident.category);

        // Scroll to top
        window.scrollTo(0, 0);

        document.getElementById("detailTitle").textContent =
          currentIncident.subcat || cat.name;
        document.getElementById("detailSubtitle").textContent =
          `${currentIncident.student} ‚Ä¢ ${currentIncident.class} ‚Ä¢ Documented ${currentIncident.date}`;
        document.getElementById("detailStatus").textContent =
          statusNames[currentIncident.status];
        document.getElementById("detailStatus").className =
          "status-badge status-" + currentIncident.status;
        document.getElementById("detailDescription").textContent =
          currentIncident.description;
        document.getElementById("detailActions").textContent =
          currentIncident.actions;

        document.getElementById("detailInfo").innerHTML = `
                <span class="info-label">Student</span><span class="info-value">${currentIncident.student}</span>
                <span class="info-label">Class</span><span class="info-value">${currentIncident.class}</span>
                <span class="info-label">Kategori</span><span class="info-value">${cat.icon} ${cat.name}</span>
                <span class="info-label">Underkategori</span><span class="info-value">${currentIncident.subcat || "-"}</span>
                <span class="info-label">Severity</span><span class="info-value"><span class="status-badge" style="background:${getSeverityColor(currentIncident.severity)}">${severityNames[currentIncident.severity]}</span></span>
                <span class="info-label">Documented av</span><span class="info-value">${currentIncident.reporter}</span>
                ${currentIncident.victim ? `<span class="info-label">Utsatt elev</span><span class="info-value">${currentIncident.victim}</span>` : ""}
            `;

        // Action toolbox
        renderActionToolbox();

        // Timeline
        document.getElementById("timeline").innerHTML = `
                <li class="timeline-item">
                    <div class="timeline-date">${currentIncident.date} 10:30</div>
                    <div class="timeline-text">Incident dokumenterad</div>
                    <div class="timeline-user">${currentIncident.reporter}</div>
                </li>
                ${
                  currentIncident.status !== "open"
                    ? `
                <li class="timeline-item">
                    <div class="timeline-date">${currentIncident.date} 11:00</div>
                    <div class="timeline-text">Principal notified</div>
                    <div class="timeline-user">System</div>
                </li>
                `
                    : ""
                }
            `;

        // Legal card
        const showLegal =
          ["bullying", "welfare", "violence", "extremism", "gang"].includes(
            currentIncident.category,
          ) && ["serious", "critical"].includes(currentIncident.severity);
        document
          .getElementById("legalCard")
          .classList.toggle("hidden", !showLegal);

        if (showLegal) {
          let legalItems = "";
          if (["bullying"].includes(currentIncident.category)) {
            legalItems = `
                        <div class="legal-item"><div class="action-checkbox checked" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Report to principal</strong><br><span style="font-size:0.75rem;color:var(--text-light);">6 kap. 10 ¬ß Education Act</span></div></div>
                        <div class="legal-item"><div class="action-checkbox" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Report to school authority</strong><br><span style="font-size:0.75rem;color:var(--text-light);">6 kap. 10 ¬ß Education Act</span></div></div>
                        <div class="legal-item"><div class="action-checkbox" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Investigation started</strong><br><span style="font-size:0.75rem;color:var(--text-light);">Must be done promptly</span></div></div>
                    `;
          } else if (["welfare"].includes(currentIncident.category)) {
            legalItems = `
                        <div class="legal-item"><div class="action-checkbox" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Welfare Report to social servicesen</strong><br><span style="font-size:0.75rem;color:var(--text-light);">14 kap. 1 ¬ß SoL - Immediate</span></div></div>
                    `;
          } else if (["extremism", "gang"].includes(currentIncident.category)) {
            legalItems = `
                        <div class="legal-item"><div class="action-checkbox checked" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Principal notified</strong></div></div>
                        <div class="legal-item"><div class="action-checkbox" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Welfare report considered</strong><br><span style="font-size:0.75rem;color:var(--text-light);">14 kap. 1 ¬ß SoL</span></div></div>
                        <div class="legal-item"><div class="action-checkbox" onclick="this.classList.toggle('checked')">‚úì</div><div><strong>Police contact considered</strong></div></div>
                    `;
          }
          document.getElementById("legalItems").innerHTML = legalItems;
        }

        // GDPR info
        const purpose = currentIncident.purpose || "quality";
        document.getElementById("detailPurpose").textContent =
          purposeNames[purpose];
        document.getElementById("detailLegalBasis").textContent =
          legalBasis[purpose];
        document.getElementById("detailCreated").textContent =
          currentIncident.date;

        // Calculate deletion date based on purpose
        const months = retentionMonths[purpose] || 12;
        const deletionDate = new Date(currentIncident.date);
        deletionDate.setMonth(deletionDate.getMonth() + months);
        document.getElementById("detailDeletion").textContent = deletionDate
          .toISOString()
          .split("T")[0];

        showPage("detail");
      }

      function renderActionToolbox() {
        const defaultActions = [
          {
            id: "verbal",
            name: "Verbal warning",
            checked: true,
            date: currentIncident.date + " 10:35",
          },
          {
            id: "talk",
            name: "Conversations med elev",
            checked: true,
            date: currentIncident.date + " 10:45",
          },
          {
            id: "parentcall",
            name: "Phone call with guardians",
            checked: false,
          },
          {
            id: "parentmeeting",
            name: "Meeting with guardians",
            checked: false,
          },
          { id: "counselor", name: "Referral to counselor", checked: false },
          { id: "warning", name: "Written warning", checked: false },
        ];

        document.getElementById("actionToolbox").innerHTML = defaultActions
          .map(
            (a) => `
                <li class="action-item">
                    <div class="action-checkbox ${a.checked ? "checked" : ""}" onclick="this.classList.toggle('checked')">‚úì</div>
                    <div class="action-content">
                        <div class="action-name">${a.name}</div>
                        ${a.date ? `<div class="action-date">${a.date}</div>` : ""}
                    </div>
                </li>
            `,
          )
          .join("");
      }

      function getSeverityColor(sev) {
        const colors = {
          critical: "#fed7d7",
          serious: "#feebc8",
          moderate: "#fefcbf",
          minor: "#c6f6d5",
        };
        return colors[sev] || "#e2e8f0";
      }

      // ==================== CATEGORY GRID ====================
      function renderCategoryGrid() {
        document.getElementById("categoryGrid").innerHTML = categories
          .map(
            (cat) => `
                <div class="category-card" onclick="selectCategory('${cat.id}')" id="cat-${cat.id}">
                    <div class="category-card-icon">${cat.icon}</div>
                    <div class="category-card-name">${cat.name}</div>
                </div>
            `,
          )
          .join("");
      }

      function selectCategory(catId) {
        selectedCategory = categories.find((c) => c.id === catId);
        selectedSubcats = [];

        document
          .querySelectorAll(".category-card")
          .forEach((c) => c.classList.remove("selected"));
        document.getElementById("cat-" + catId).classList.add("selected");

        // Show subcategories
        const section = document.getElementById("subcatSection");
        section.classList.add("active");
        document.getElementById("subcatTags").innerHTML =
          selectedCategory.subcats
            .map(
              (s) =>
                `<span class="subcat-tag" onclick="toggleSubcat(this, '${s}')">${s}</span>`,
            )
            .join("");

        // Show guidance
        const g = selectedCategory.guidance;
        document.getElementById("guidanceBox").innerHTML = `
                <div class="guidance-box ${g.type}">
                    <div class="guidance-title">${g.title}</div>
                    <div class="guidance-text">${g.text}</div>
                    ${g.links ? `<div class="guidance-links">${g.links.map((l) => `<a href="${l.url}" target="_blank" class="guidance-link">${l.text}</a>`).join("")}</div>` : ""}
                </div>
            `;
      }

      function toggleSubcat(el, subcat) {
        el.classList.toggle("selected");
        if (el.classList.contains("selected")) {
          selectedSubcats.push(subcat);
        } else {
          selectedSubcats = selectedSubcats.filter((s) => s !== subcat);
        }

        // Show/hide "Other" text field
        const otherField = document.getElementById("otherSubcatField");
        if (selectedSubcats.includes("Other")) {
          otherField.style.display = "block";
        } else {
          otherField.style.display = "none";
          document.getElementById("otherSubcatText").value = "";
        }
      }

      // ==================== PERSON SECTIONS ====================
      function addPerson(listId, role) {
        const list = document.getElementById(listId);
        const newEntry = document.createElement("div");
        newEntry.className = "person-entry";
        newEntry.setAttribute("data-role", role);
        newEntry.style.cssText =
          "display:grid;grid-template-columns:1fr 120px 40px;gap:0.5rem;align-items:end;margin-bottom:0.5rem;";
        newEntry.innerHTML = `
                <div class="form-group" style="margin:0;">
                    <input type="text" class="form-input person-name" placeholder="First and last name">
                </div>
                <div class="form-group" style="margin:0;">
                    <input type="text" class="form-input person-class" placeholder="${role === "reported" ? "E.g. 8B" : "Class el. Personal"}">
                </div>
                <button type="button" onclick="removePerson(this)" style="background:var(--error);color:white;border:none;border-radius:4px;padding:0.4rem 0.6rem;cursor:pointer;font-size:0.8rem;">√ó</button>
            `;
        list.appendChild(newEntry);
      }

      function removePerson(btn) {
        btn.closest(".person-entry").remove();
      }

      function collectPersons(listId) {
        const persons = [];
        document
          .querySelectorAll(`#${listId} .person-entry`)
          .forEach((entry) => {
            const name = entry.querySelector(".person-name").value.trim();
            const classVal = entry.querySelector(".person-class").value.trim();
            if (name) {
              persons.push({
                name,
                class: classVal,
                role: entry.getAttribute("data-role"),
              });
            }
          });
        return persons;
      }

      // ==================== WIZARD ====================
      function nextStep() {
        if (currentStep === 1) {
          if (
            !document.getElementById("inputStudentName").value ||
            !document.getElementById("inputClass").value
          ) {
            showToast("Fyll i elevens namn och klass", "error");
            return;
          }
        }
        if (currentStep === 2) {
          if (!selectedCategory) {
            showToast("Select a category", "error");
            return;
          }
        }
        if (currentStep === 3) {
          if (
            !selectedSeverity ||
            !document.getElementById("inputLocation").value ||
            !document.getElementById("inputDescription").value
          ) {
            showToast("Fill in all required fields", "error");
            return;
          }
          // Prepare action checklist for step 4
          renderWizardActionChecklist();
        }
        if (currentStep === 4) {
          // Validate at least one escalation for serious cases
          if (
            (selectedSeverity === "serious" ||
              selectedSeverity === "critical") &&
            !wizardEscalations.principal
          ) {
            showToast(
              "Principal must be notified for serious incidents",
              "error",
            );
            return;
          }
        }
        if (currentStep === 5) {
          if (!selectedPurpose) {
            showToast("Select documentation purpose", "error");
            return;
          }
          submitReport();
          return;
        }

        currentStep++;
        updateWizard();
      }

      function prevStep() {
        if (currentStep > 1) {
          currentStep--;
          updateWizard();
        }
      }

      function updateWizard() {
        // Scroll to top of page
        window.scrollTo(0, 0);

        // Hide all steps
        for (let i = 1; i <= 5; i++) {
          document.getElementById("step" + i).style.display = "none";
          document
            .getElementById("step" + i + "-tab")
            .classList.remove("active", "completed");
        }

        // Show current step
        document.getElementById("step" + currentStep).style.display = "block";
        document
          .getElementById("step" + currentStep + "-tab")
          .classList.add("active");

        // Mark completed steps
        for (let i = 1; i < currentStep; i++) {
          document
            .getElementById("step" + i + "-tab")
            .classList.add("completed");
        }

        // Update buttons
        document.getElementById("prevBtn").style.visibility =
          currentStep > 1 ? "visible" : "hidden";
        document.getElementById("nextBtn").textContent =
          currentStep === 5 ? "Submit ‚úì" : "Next ‚Üí";

        // If step 5, render review
        if (currentStep === 5) {
          renderReview();
        }
      }

      // Category-specific action lists
      const categoryActions = {
        bullying: [
          {
            group: "üë• Conversations",
            items: [
              "Talk with involved student",
              "Talk with affected student",
              "Talk with witnesses",
              "Class council/group discussion",
            ],
          },
          {
            group: "üë®‚Äçüë©‚Äçüëß Guardians",
            items: [
              "Contact guardians (involved student)",
              "Contact guardians (affected student)",
              "Meeting with all guardians",
            ],
          },
          {
            group: "üìÑ Documentation",
            items: [
              "Documented in student file",
              "Action plan established",
              "Follow-up date set",
            ],
          },
        ],
        violence: [
          {
            group: "üö® Immediate",
            items: [
              "First aid given",
              "Students separated",
              "Location secured",
            ],
          },
          {
            group: "üë• Conversations",
            items: [
              "Conversations med inblandade elever",
              "Talk with witnesses",
            ],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact med alla VH"] },
          {
            group: "üìÑ Documentation",
            items: [
              "Documented in student file",
              "Work environment report",
              "Injury report",
            ],
          },
        ],
        welfare: [
          {
            group: "üí¨ Conversations",
            items: [
              "Talk with the student",
              "Talk with classmates",
              "Talk with teachers who know the student",
            ],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          {
            group: "üè• Student Health",
            items: [
              "Counselor notified",
              "School Nurse notified",
              "Psychologist notified",
            ],
          },
          {
            group: "üìÑ Documentation",
            items: ["Documented in student file", "Action plan established"],
          },
        ],
        disruption: [
          {
            group: "üë• Conversations",
            items: ["Talk with the student", "Conversations med klass/grupp"],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          {
            group: "üìÑ Actions",
            items: ["Adaptations agreed", "Follow-up date set"],
          },
        ],
        absence: [
          {
            group: "üìû Contact",
            items: ["Phone call with guardians", "Home visit completed"],
          },
          {
            group: "üë• Conversations",
            items: ["Talk with the student", "Meeting with guardians"],
          },
          {
            group: "üìÑ Documentation",
            items: [
              "Absence registered",
              "Attendance team notified",
              "Action plan established",
            ],
          },
        ],
        substance: [
          {
            group: "üö® Immediate",
            items: ["Student taken care of", "Items confiscated"],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          {
            group: "üìÑ Documentation",
            items: ["Documented in student file", "Action plan established"],
          },
        ],
        theft: [
          {
            group: "üîç Investigation",
            items: [
              "Talk with suspected student",
              "Talk with witnesses",
              "Inventory completed",
            ],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          {
            group: "üìÑ Documentation",
            items: ["Documented in student file", "Injury report"],
          },
        ],
        digital: [
          {
            group: "üíª Investigation",
            items: [
              "Screenshots secured",
              "Platform identified",
              "Spread investigated",
            ],
          },
          {
            group: "üë• Conversations",
            items: ["Talk with involved student", "Talk with affected student"],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact med alla VH"] },
          {
            group: "üìÑ Documentation",
            items: ["Documented in student file", "Report to platform"],
          },
        ],
        extremism: [
          {
            group: "üîç Investigation",
            items: ["Material secured", "Extent investigated"],
          },
          {
            group: "üë• Conversations",
            items: ["Talk with the student", "Counselor notified"],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          {
            group: "üìÑ Documentation",
            items: ["Documented in student file", "Action plan established"],
          },
        ],
        gang: [
          {
            group: "üîç Investigation",
            items: ["Situation kartlagd", "Kopplingar utredda"],
          },
          {
            group: "üë• Conversations",
            items: ["Talk with the student", "Counselor notified"],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          {
            group: "üèõÔ∏è External",
            items: ["Social services contacted", "Police contacted"],
          },
        ],
        other: [
          {
            group: "üë• Conversations",
            items: ["Conversations med inblandade"],
          },
          { group: "üë®‚Äçüë©‚Äçüëß Guardians", items: ["Contact with Guardians"] },
          { group: "üìÑ Documentation", items: ["Documented in student file"] },
        ],
      };

      // Track wizard action states
      let wizardActionStates = {};
      let wizardEscalations = {};

      function renderWizardActionChecklist() {
        const category = selectedCategory?.id || "other";
        const actions = categoryActions[category] || categoryActions.other;

        wizardActionStates = {};
        let html = "";
        let totalItems = 0;

        actions.forEach((group) => {
          html += `<div class="action-group">
                    <div class="action-group-title">${group.group}</div>`;
          group.items.forEach((item, idx) => {
            const key = category + "_" + idx + "_" + item.replace(/\s/g, "_");
            wizardActionStates[key] = "none";
            totalItems++;
            html += `<div class="action-item" onclick="cycleWizardAction(this, '${key}')" data-key="${key}">
                        <div class="action-toggle"></div>
                        <span class="action-label">${item}</span>
                        <span class="action-date"></span>
                    </div>`;
          });
          html += "</div>";
        });

        document.getElementById("wizardActionChecklist").innerHTML = html;
        document.getElementById("wizardActionProgress").textContent =
          "0 av " + totalItems + " marked";

        // Auto-check principal escalation for serious/critical
        if (selectedSeverity === "serious" || selectedSeverity === "critical") {
          const principalStep = document.querySelector("#principalEscalation");
          if (principalStep && !principalStep.classList.contains("completed")) {
            principalStep.classList.add("planned");
            principalStep.querySelector(".step-checkbox").textContent = "‚óê";
            principalStep.querySelector(".step-status").className =
              "step-status pending";
            principalStep.querySelector(".step-status").textContent =
              "Must be notified";
            wizardEscalations.principal = "planned";
          }
        }
      }

      function cycleWizardAction(element, key) {
        const states = ["none", "planned", "done", "na"];
        const icons = ["", "‚óê", "‚úì", "‚Äì"];
        const dates = [
          "",
          "Planned",
          new Date().toISOString().split("T")[0],
          "Not applicable",
        ];

        let currentIndex = states.indexOf(wizardActionStates[key] || "none");
        let nextIndex = (currentIndex + 1) % states.length;

        wizardActionStates[key] = states[nextIndex];

        // Update UI
        element.className =
          "action-item" +
          (states[nextIndex] !== "none" ? " state-" + states[nextIndex] : "");
        element.querySelector(".action-toggle").textContent = icons[nextIndex];
        element.querySelector(".action-date").textContent = dates[nextIndex];

        // Update progress
        const done = Object.values(wizardActionStates).filter(
          (s) => s === "done" || s === "planned",
        ).length;
        const total = Object.keys(wizardActionStates).length;
        document.getElementById("wizardActionProgress").textContent =
          done + " av " + total + " marked";
      }

      function toggleWizardEscalation(element, role) {
        const states = ["none", "planned", "done"];
        const icons = ["", "‚óê", "‚úì"];
        const statusClasses = ["waiting", "pending", "done"];
        const statusTexts = [
          "Not notified",
          "Ska informeras",
          "Informerad " +
            new Date().toLocaleTimeString("sv-SE", {
              hour: "2-digit",
              minute: "2-digit",
            }),
        ];

        let currentState = wizardEscalations[role] || "none";
        let currentIndex = states.indexOf(currentState);
        let nextIndex = (currentIndex + 1) % states.length;

        // Don't allow unchecking principal for serious cases
        if (
          role === "principal" &&
          (selectedSeverity === "serious" || selectedSeverity === "critical") &&
          nextIndex === 0
        ) {
          nextIndex = 1; // Keep at least as planned
          showToast(
            "Principal must be notified for serious incidents",
            "warning",
          );
        }

        wizardEscalations[role] = states[nextIndex];

        // Update UI
        element.classList.remove("planned", "completed");
        if (states[nextIndex] === "planned") element.classList.add("planned");
        if (states[nextIndex] === "done") element.classList.add("completed");

        element.querySelector(".step-checkbox").textContent = icons[nextIndex];
        element.querySelector(".step-status").className =
          "step-status " + statusClasses[nextIndex];
        element.querySelector(".step-status").textContent =
          statusTexts[nextIndex];

        // Update progress
        const done = Object.values(wizardEscalations).filter(
          (s) => s === "done" || s === "planned",
        ).length;
        document.getElementById("wizardEscalationProgress").textContent =
          done + " av " + Object.keys(wizardEscalations).length + " notified";
      }

      function renderReview() {
        const cat = selectedCategory;

        // Count actions taken
        const actionsDone = Object.values(wizardActionStates).filter(
          (s) => s === "done",
        ).length;
        const actionsPlanned = Object.values(wizardActionStates).filter(
          (s) => s === "planned",
        ).length;

        // Get escalations
        const escalationsDone = Object.entries(wizardEscalations)
          .filter(([k, v]) => v === "done")
          .map(([k]) => getEscalationName(k));
        const escalationsPlanned = Object.entries(wizardEscalations)
          .filter(([k, v]) => v === "planned")
          .map(([k]) => getEscalationName(k));

        // Collect persons from each section
        const reportedStudents = collectPersons("reportedStudentsList");
        const affectedPersons = collectPersons("affectedPersonsList");
        const witnesses = collectPersons("witnessesList");

        // Format person lists
        const formatPersonList = (persons) =>
          persons.length > 0
            ? persons
                .map((p) => `${p.name}${p.class ? " (" + p.class + ")" : ""}`)
                .join(", ")
            : "-";

        document.getElementById("reviewContent").innerHTML = `
                <span class="info-label">Reported Student</span><span class="info-value">${formatPersonList(reportedStudents)}</span>
                <span class="info-label">Utsatta</span><span class="info-value">${formatPersonList(affectedPersons)}</span>
                <span class="info-label">Witnesses</span><span class="info-value">${formatPersonList(witnesses)}</span>
                <span class="info-label">Kategori</span><span class="info-value">${cat.icon} ${cat.name}</span>
                <span class="info-label">Specificering</span><span class="info-value">${selectedSubcats.join(", ") || "-"}</span>
                <span class="info-label">Severity</span><span class="info-value">${severityNames[selectedSeverity]}</span>
                <span class="info-label">Date</span><span class="info-value">${document.getElementById("inputDate").value}</span>
                <span class="info-label">Location</span><span class="info-value">${document.getElementById("inputLocation").value}</span>
                <span class="info-label">Actions completed</span><span class="info-value">${actionsDone} pcs</span>
                <span class="info-label">Actions planerade</span><span class="info-value">${actionsPlanned} pcs</span>
                <span class="info-label">Notified</span><span class="info-value">${escalationsDone.length > 0 ? escalationsDone.join(", ") : "None yet"}</span>
                <span class="info-label">Ska informeras</span><span class="info-value">${escalationsPlanned.length > 0 ? escalationsPlanned.join(", ") : "-"}</span>
            `;

        // Show warning for serious categories
        const showWarning =
          ["violence", "welfare", "extremism", "gang"].includes(cat.id) ||
          selectedSeverity === "critical";
        document.getElementById("reviewWarning").style.display = showWarning
          ? "block"
          : "none";
        if (showWarning) {
          let warningText = "Principal kommer att informeras automatiskt. ";
          if (cat.id === "welfare")
            warningText +=
              "Consider if welfare report to social services needs to be made.";
          if (cat.id === "extremism" || cat.id === "gang")
            warningText +=
              "Counselor and possibly police/social services should be contacted.";
          document.getElementById("reviewWarningText").textContent =
            warningText;
        }
      }

      function getEscalationName(key) {
        const names = {
          mentor: "Mentor",
          headofyear: "Head of Year",
          counselor: "Counselor",
          principal: "Principal",
          guardian: "Guardians",
          socialservices: "Social services",
          police: "Polis",
        };
        return names[key] || key;
      }

      function resetWizard() {
        currentStep = 1;
        selectedCategory = null;
        selectedSubcats = [];
        selectedSeverity = null;
        wizardActionStates = {};
        wizardEscalations = {};

        // Reset reported students section - keep only first entry
        const reportedList = document.getElementById("reportedStudentsList");
        const reportedEntries = reportedList.querySelectorAll(".person-entry");
        reportedEntries.forEach((entry, idx) => {
          if (idx === 0) {
            entry.querySelectorAll("input").forEach((inp) => (inp.value = ""));
          } else {
            entry.remove();
          }
        });

        // Reset affected persons section - keep only first entry
        const affectedList = document.getElementById("affectedPersonsList");
        const affectedEntries = affectedList.querySelectorAll(".person-entry");
        affectedEntries.forEach((entry, idx) => {
          if (idx === 0) {
            entry.querySelectorAll("input").forEach((inp) => (inp.value = ""));
          } else {
            entry.remove();
          }
        });

        // Reset witnesses section - keep only first entry
        const witnessList = document.getElementById("witnessesList");
        const witnessEntries = witnessList.querySelectorAll(".person-entry");
        witnessEntries.forEach((entry, idx) => {
          if (idx === 0) {
            entry.querySelectorAll("input").forEach((inp) => (inp.value = ""));
          } else {
            entry.remove();
          }
        });

        document.getElementById("inputLocation").value = "";
        document.getElementById("inputDescription").value = "";
        document.getElementById("inputActions").value = "";
        document.getElementById("inputDate").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("inputTime").value = "";

        document
          .querySelectorAll(".category-card")
          .forEach((c) => c.classList.remove("selected"));
        document
          .querySelectorAll(".severity-card")
          .forEach((c) => c.classList.remove("selected"));
        document.getElementById("subcatSection").classList.remove("active");
        document.getElementById("guidanceBox").innerHTML = "";

        // Reset wizard escalation steps
        document
          .querySelectorAll(
            "#wizardEscalationSteps .workflow-step, #externalEscalation .workflow-step",
          )
          .forEach((step) => {
            step.classList.remove("planned", "completed");
            step.querySelector(".step-checkbox").textContent = "";
            step.querySelector(".step-status").className =
              "step-status waiting";
            step.querySelector(".step-status").textContent = "Not notified";
          });

        updateWizard();
      }

      function confirmExit() {
        showModal("confirmExitModal");
      }

      function submitReport() {
        document.getElementById("caseNumber").textContent =
          "INC-2025-00" + (42 + Math.floor(Math.random() * 10));
        showPage("success");
        showToast("Incident dokumenterad", "success");
      }

      function selectSeverity(el, sev) {
        document
          .querySelectorAll(".severity-card")
          .forEach((c) => c.classList.remove("selected"));
        el.classList.add("selected");
        selectedSeverity = sev;
        // Check auto-share requirements
        checkAutoShare();
      }

      // ==================== AUTO-SHARE LOGIC ====================
      // Categories that ALWAYS require auto-share to rektor + mentor
      const autoShareCategories = [
        "bullying",
        "violence",
        "welfare",
        "substance",
        "extremism",
        "gang",
        "digital",
      ];

      function shouldAutoShare() {
        // Always auto-share for serious/critical severity
        if (selectedSeverity === "serious" || selectedSeverity === "critical") {
          return true;
        }
        // Always auto-share for certain categories
        if (
          selectedCategory &&
          autoShareCategories.includes(selectedCategory.id)
        ) {
          return true;
        }
        return false;
      }

      function getAutoShareReason() {
        const reasons = [];
        if (selectedSeverity === "serious") {
          reasons.push("Severity: Serious");
        }
        if (selectedSeverity === "critical") {
          reasons.push("Severity: Kritisk");
        }
        if (selectedCategory) {
          if (selectedCategory.id === "bullying") {
            reasons.push(
              "Harassment requires principal action (6 kap. 10 ¬ß Education Act)",
            );
          }
          if (selectedCategory.id === "violence") {
            reasons.push(
              "Violence/threats require safety measures (Work Environment Act)",
            );
          }
          if (selectedCategory.id === "welfare") {
            reasons.push(
              "Welfare concern may require welfare report (14 kap. 1 ¬ß SoL)",
            );
          }
          if (selectedCategory.id === "substance") {
            reasons.push("Drug-related incidents require principal assessment");
          }
          if (
            selectedCategory.id === "extremism" ||
            selectedCategory.id === "gang"
          ) {
            reasons.push("Safety case requires immediate escalation");
          }
        }
        return reasons.join(". ");
      }

      function checkAutoShare() {
        const warning = document.getElementById("autoShareWarning");
        if (!warning) return;

        if (shouldAutoShare()) {
          const recipients = document.getElementById("autoShareRecipients");
          const reason = document.getElementById("autoShareReason");

          recipients.innerHTML = `
                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem;">
                        <span>‚úì</span> <strong>Principal</strong> (skolans ledning)
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <span>‚úì</span> <strong>Mentor</strong> (student's responsible teacher)
                    </div>
                `;
          reason.textContent = getAutoShareReason();
          warning.style.display = "block";

          // Auto-check mentor and principal in escalation
          wizardEscalations.mentor = true;
          wizardEscalations.principal = true;
          updateWizardEscalationDisplay();
        } else {
          warning.style.display = "none";
        }
      }

      function updateWizardEscalationDisplay() {
        const steps = document.querySelectorAll(
          "#wizardEscalationSteps .workflow-step",
        );
        steps.forEach((step) => {
          const role = step.getAttribute("onclick")?.match(/'(\w+)'/)?.[1];
          if (role && wizardEscalations[role]) {
            step.classList.add("completed");
            step.querySelector(".step-checkbox").textContent = "‚úì";
            step.querySelector(".step-status").textContent = "Auto-delad";
            step.querySelector(".step-status").className = "step-status done";
          }
        });
        updateWizardEscalationProgress();
      }

      // ==================== FILE UPLOAD ====================
      let uploadedFiles = [];

      function handleFileUpload(files) {
        for (let file of files) {
          if (file.size > 10 * 1024 * 1024) {
            showToast("File is too large (max 10 MB)", "error");
            continue;
          }
          uploadedFiles.push(file);
        }
        renderAttachments();
      }

      function renderAttachments() {
        const list = document.getElementById("attachmentsList");
        const count = document.getElementById("attachmentCount");

        if (uploadedFiles.length === 0) {
          list.innerHTML = "";
          count.textContent = "0 files";
          return;
        }

        count.textContent =
          uploadedFiles.length +
          " fil" +
          (uploadedFiles.length > 1 ? "er" : "");
        list.innerHTML = uploadedFiles
          .map(
            (f, i) => `
                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem;background:#f7fafc;border-radius:6px;margin-bottom:0.5rem;">
                    <span>${f.type.includes("image") ? "üñºÔ∏è" : f.type.includes("pdf") ? "üìÑ" : "üìé"}</span>
                    <span style="flex:1;font-size:0.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name}</span>
                    <span style="font-size:0.75rem;color:var(--text-light);">${(f.size / 1024).toFixed(0)} KB</span>
                    <button onclick="removeFile(${i})" style="background:none;border:none;color:var(--error);cursor:pointer;padding:0.25rem;">√ó</button>
                </div>
            `,
          )
          .join("");
      }

      function removeFile(index) {
        uploadedFiles.splice(index, 1);
        renderAttachments();
      }

      // ==================== EHT INTEGRATION ====================
      document.addEventListener("DOMContentLoaded", function () {
        const ehtCheckbox = document.getElementById("ehtCheckbox");
        if (ehtCheckbox) {
          ehtCheckbox.addEventListener("change", function () {
            const info = document.getElementById("ehtMeetingInfo");
            if (this.checked) {
              // Calculate next Thursday
              const today = new Date();
              const daysUntilThursday = (4 - today.getDay() + 7) % 7 || 7;
              const nextThursday = new Date(today);
              nextThursday.setDate(today.getDate() + daysUntilThursday);
              const dateStr = nextThursday.toLocaleDateString("sv-SE", {
                weekday: "long",
                day: "numeric",
                month: "numeric",
              });
              document.getElementById("ehtMeetingDate").textContent = dateStr;
              info.style.display = "inline";
            } else {
              info.style.display = "none";
            }
          });
        }
      });

      // ==================== PURPOSE DROPDOWN ====================
      function updatePurposeSelection(value) {
        selectedPurpose = value;
        const desc = document.getElementById("purposeDescription");
        const descriptions = {
          disciplinary:
            "Documentation of disciplinary actions under Chapter 5 Education Act. Retention period: 12 months.",
          harassment:
            "Investigation of harassment under Chapter 6 Section 10. Legal obligation. Retention period: 24 months.",
          safety:
            "Documentation of safety incidents under Work Environment Act. Retention period: 24 months.",
          welfare:
            "Documentation of student welfare concerns. May form basis for welfare report. Retention period: 36 months.",
          quality:
            "Basis for systematic quality work. Anonymized after closure. Retention period: 12 months.",
        };
        if (value && descriptions[value]) {
          desc.textContent = descriptions[value];
          desc.style.display = "block";
        } else {
          desc.style.display = "none";
        }
        // Update retention display
        updateRetentionDisplay();
      }

      function updateRetentionDisplay() {
        const retention = document.getElementById("retentionPeriod");
        const deletion = document.getElementById("deletionDate");
        const months = retentionMonths[selectedPurpose] || 12;
        const deletionDate = new Date();
        deletionDate.setMonth(deletionDate.getMonth() + months);
        if (retention) retention.textContent = months + " months";
        if (deletion)
          deletion.textContent = deletionDate.toISOString().split("T")[0];
      }

      // ==================== TASK FILTERING ====================
      function filterTasks(filter, btn) {
        // Update button states
        document.querySelectorAll(".task-filter-btn").forEach((b) => {
          b.classList.remove("active");
          b.classList.add("btn-ghost");
        });
        btn.classList.add("active");
        btn.classList.remove("btn-ghost");

        // Show/hide sections
        document.querySelectorAll(".task-section").forEach((section) => {
          const filters = section.getAttribute("data-filter")?.split(" ") || [];
          if (filter === "all" || filters.includes(filter)) {
            section.style.display = "block";
          } else {
            section.style.display = "none";
          }
        });
      }

      function updateTaskStatus(select, taskId) {
        const value = select.value;
        showToast(
          "Uppgiftsstatus uppdaterad till: " +
            select.options[select.selectedIndex].text,
          "success",
        );
      }

      // ==================== PARENT CONTACT LOG ====================
      function addParentContact() {
        const types = ["üìû Phone call", "‚úâÔ∏è Email", "ü§ù Meeting", "üí¨ SMS"];
        const type = prompt(
          "Select contact type:\n1. Phone call\n2. Email\n3. Meeting\n4. SMS",
        );
        const notes = prompt("Notes from the contact:");

        if (type && notes) {
          const typeIndex = parseInt(type) - 1;
          const typeLabel = types[typeIndex] || types[0];
          const now = new Date().toLocaleString("sv-SE");

          const log = document.getElementById("parentContactLog");
          const entry = document.createElement("div");
          entry.className = "contact-entry";
          entry.style.cssText =
            "border-left:3px solid var(--primary);padding-left:1rem;margin-bottom:1rem;";
          entry.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <strong style="font-size:0.85rem;">${typeLabel}</strong>
                            <span style="font-size:0.75rem;color:var(--text-light);margin-left:0.5rem;">${users.find((u) => u.role === currentRole)?.name || "Du"}</span>
                        </div>
                        <span style="font-size:0.75rem;color:var(--text-light);">${now}</span>
                    </div>
                    <p style="font-size:0.8rem;color:var(--text);margin-top:0.25rem;">${notes}</p>
                `;
          log.insertBefore(entry, log.firstChild);
          showToast("Contact loggad", "success");
        }
      }

      // ==================== ADMIN ====================
      function renderAdminUsers() {
        document.getElementById("adminUserList").innerHTML = users
          .map(
            (u) => `
                <tr>
                    <td>${u.name}</td>
                    <td><span class="role-tag ${u.role}">${roleNames[u.role]}</span></td>
                    <td>
                        <div class="access-tags">
                            ${u.access.length ? u.access.map((a) => `<span class="access-tag">${a}</span>`).join("") : '<span class="access-tag">Egna dokumentationer</span>'}
                        </div>
                    </td>
                    <td style="font-size:0.8rem;">${u.email}</td>
                    <td><button class="btn btn-sm btn-ghost" onclick="showModal('editUserModal')">Redigera</button></td>
                </tr>
            `,
          )
          .join("");
      }

      function showAdminTab(elOrTab, tab) {
        // Handle both old and new calling conventions
        let actualTab = tab;
        let el = elOrTab;
        if (typeof elOrTab === "string") {
          actualTab = elOrTab;
          el = null;
        }

        document.querySelectorAll(".admin-tab").forEach((t) => {
          t.style.color = "var(--text-light)";
          t.style.borderBottomColor = "transparent";
        });
        document
          .querySelectorAll(".admin-panel")
          .forEach((p) => (p.style.display = "none"));

        // Find and highlight the correct tab
        const tabs = document.querySelectorAll(".admin-tab");
        const tabIndex = { users: 0, gdpr: 1, statistics: 2, settings: 3 };
        const targetTab = tabs[tabIndex[actualTab]];
        if (targetTab) {
          targetTab.style.color = "var(--primary)";
          targetTab.style.borderBottomColor = "var(--primary)";
        }

        document.getElementById("panel-" + actualTab).style.display = "block";
      }

      // ==================== GDPR FUNCTIONS ====================
      let selectedPurpose = null;

      function selectPurpose(el, purpose) {
        selectedPurpose = purpose;
        document.querySelectorAll(".purpose-option").forEach((o) => {
          o.style.borderColor = "#9ae6b4";
          o.style.background = "white";
        });
        el.style.borderColor = "var(--primary)";
        el.style.background = "rgba(56, 108, 112, 0.05)";

        // Update retention period based on purpose
        const retentionMonths = {
          disciplinary: 12,
          harassment: 36,
          safety: 24,
          welfare: 36,
          quality: 12,
        };

        const months = retentionMonths[purpose] || 12;
        document.getElementById("retentionPeriod").textContent =
          months + " months";

        const deletionDate = new Date();
        deletionDate.setMonth(deletionDate.getMonth() + months);
        document.getElementById("deletionDate").textContent = deletionDate
          .toISOString()
          .split("T")[0];
      }

      function exportStudentData() {
        showToast("Preparing data export...", "success");
      }

      // ==================== MODALS ====================
      function showModal(id) {
        document.getElementById(id).classList.add("active");
        if (id === "editUserModal" || id === "addUserModal") renderAdminUsers();
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }

      document.querySelectorAll(".modal-overlay").forEach((m) => {
        m.addEventListener("click", function (e) {
          if (e.target === this) this.classList.remove("active");
        });
      });

      // ==================== ACTIONS ====================
      function addAction() {
        const select = document.getElementById("actionSelect");
        if (!select.value) {
          showToast("Select an action", "error");
          return;
        }
        showToast("Action added", "success");
        closeModal("addActionModal");
        select.value = "";
        document.getElementById("actionNote").value = "";
      }

      function closeCase() {
        showToast("Case marked as closed", "success");
      }

      function generateDoc(type) {
        const names = {
          welfare: "Welfare Report",
          police: "Police Report",
          investigation: "Investigation",
          warning: "Written warning",
          parent: "Brev",
          plan: "Action program",
        };
        showToast("Skapar " + names[type] + "...", "success");
        closeModal("documentModal");
      }

      function filterByUrgent() {
        document.getElementById("statusFilter").value = "open";
        document.getElementById("severityFilter").value = "critical";
        showPage("list");
      }

      function filterByFollowup() {
        document.getElementById("statusFilter").value = "followup";
        showPage("list");
      }

      function filterByMonth() {
        // Reset all filters and show all incidents from this month
        document.getElementById("statusFilter").value = "";
        document.getElementById("severityFilter").value = "";
        document.getElementById("categoryFilter").value = "";
        showPage("list");
        showToast("Showing all cases this month", "info");
      }

      function filterByOpen() {
        document.getElementById("statusFilter").value = "open";
        document.getElementById("severityFilter").value = "";
        document.getElementById("categoryFilter").value = "";
        showPage("list");
      }

      function filterByCritical() {
        document.getElementById("severityFilter").value = "critical";
        document.getElementById("statusFilter").value = "";
        document.getElementById("categoryFilter").value = "";
        showPage("list");
      }

      function filterByClosed() {
        document.getElementById("statusFilter").value = "closed";
        document.getElementById("severityFilter").value = "";
        document.getElementById("categoryFilter").value = "";
        showPage("list");
      }

      // ==================== WORKFLOW MANAGEMENT ====================

      // Cycle through action states: none -> planned -> done -> na -> none
      function cycleActionState(element) {
        const states = ["", "state-planned", "state-done", "state-na"];
        const icons = ["", "‚óê", "‚úì", "‚Äì"];
        const dateTexts = [
          "",
          "Planned",
          new Date().toISOString().split("T")[0],
          "Not applicable",
        ];

        let currentIndex = 0;
        for (let i = 0; i < states.length; i++) {
          if (states[i] && element.classList.contains(states[i])) {
            currentIndex = i;
            break;
          }
        }

        // Remove current state
        states.forEach((s) => {
          if (s) element.classList.remove(s);
        });

        // Move to next state
        const nextIndex = (currentIndex + 1) % states.length;
        if (states[nextIndex]) {
          element.classList.add(states[nextIndex]);
        }

        // Update icon
        element.querySelector(".action-toggle").textContent = icons[nextIndex];

        // Update date
        const dateEl = element.querySelector(".action-date");
        if (nextIndex === 2) {
          // done
          dateEl.textContent = new Date().toISOString().split("T")[0];
        } else if (nextIndex === 1) {
          // planned
          dateEl.textContent = "Planned";
        } else if (nextIndex === 3) {
          // na
          dateEl.textContent = "Not applicable";
        } else {
          dateEl.textContent = "";
        }

        // Update progress counter
        updateActionProgress();

        showToast("Action updated", "success");
      }

      // Toggle escalation step
      function toggleEscalationStep(element, index) {
        const states = ["", "planned", "completed"];
        const icons = ["", "‚óê", "‚úì"];
        const statusClasses = ["waiting", "pending", "done"];
        const statusTexts = [
          "Waiting",
          "In progress",
          "Completet " +
            new Date().toLocaleTimeString("sv-SE", {
              hour: "2-digit",
              minute: "2-digit",
            }),
        ];

        let currentIndex = 0;
        if (element.classList.contains("planned")) currentIndex = 1;
        if (element.classList.contains("completed")) currentIndex = 2;

        // Remove current state
        element.classList.remove("planned", "completed");

        // Move to next state
        const nextIndex = (currentIndex + 1) % states.length;
        if (states[nextIndex]) {
          element.classList.add(states[nextIndex]);
        }

        // Update icon
        element.querySelector(".step-checkbox").textContent = icons[nextIndex];

        // Update status
        const statusEl = element.querySelector(".step-status");
        statusEl.className = "step-status " + statusClasses[nextIndex];
        statusEl.textContent = statusTexts[nextIndex];

        // Update progress and chain
        updateEscalationProgress();

        showToast("Eskaleringssteg uppdaterat", "success");
      }

      function updateActionProgress() {
        const items = document.querySelectorAll(
          "#actionChecklistItems .action-item",
        );
        const done = document.querySelectorAll(
          "#actionChecklistItems .action-item.state-done",
        ).length;
        const total = items.length;
        document.getElementById("actionProgress").textContent =
          done + " av " + total + " completed";
      }

      function updateEscalationProgress() {
        const steps = document.querySelectorAll(
          "#escalationSteps .workflow-step",
        );
        const done = document.querySelectorAll(
          "#escalationSteps .workflow-step.completed",
        ).length;
        const total = steps.length;
        document.getElementById("escalationProgress").textContent =
          done + " av " + total + " completed";

        // Update chain badges
        const badges = document.querySelectorAll(
          "#escalationChain .escalation-badge",
        );
        steps.forEach((step, i) => {
          if (i + 1 < badges.length) {
            // Skip "Reporter" badge
            const badge = badges[i + 1];
            badge.classList.remove("done", "active");
            if (step.classList.contains("completed")) {
              badge.classList.add("done");
            } else if (step.classList.contains("planned")) {
              badge.classList.add("active");
            }
          }
        });
      }

      // ==================== EHT PAGE ====================
      function showEhtTab(tab) {
        // Update tab buttons
        document.querySelectorAll(".eht-tab").forEach((t) => {
          t.classList.remove("active");
          t.classList.add("btn-ghost");
        });
        document
          .getElementById("ehtTab" + tab.charAt(0).toUpperCase() + tab.slice(1))
          .classList.add("active");
        document
          .getElementById("ehtTab" + tab.charAt(0).toUpperCase() + tab.slice(1))
          .classList.remove("btn-ghost");

        // Show correct panel
        document
          .querySelectorAll(".eht-panel")
          .forEach((p) => (p.style.display = "none"));
        document.getElementById(
          "ehtPanel" + tab.charAt(0).toUpperCase() + tab.slice(1),
        ).style.display = "block";
      }

      let currentEhtCaseId = null;
      let currentEhtStudent = "";

      function showEhtDecisionModal(caseId, studentName) {
        currentEhtCaseId = caseId;
        currentEhtStudent = studentName;
        document.getElementById("ehtDecisionStudent").textContent = studentName;
        document.getElementById("ehtDecisionCase").textContent =
          "INC-2025-00" + (40 + caseId);
        document.getElementById("ehtDecisionText").value = "";
        showModal("ehtDecisionModal");
      }

      function saveEhtDecision() {
        const decision = document.getElementById("ehtDecisionText").value;
        const responsible = document.getElementById(
          "ehtDecisionResponsible",
        ).value;
        const followup = document.getElementById("ehtDecisionFollowup").value;
        const addToTimeline = document.getElementById(
          "ehtDecisionAddToTimeline",
        ).checked;

        if (!decision) {
          showToast("Ange ett beslut", "error");
          return;
        }

        closeModal("ehtDecisionModal");
        showToast("EHT Decision saved for " + currentEhtStudent, "success");

        // In a real system, this would save to database and optionally add to timeline
      }

      function completeEhtMeeting() {
        if (
          confirm(
            "Do you want to complete the EHT meeting and save all decisions?",
          )
        ) {
          showToast("EHT meeting completed. Decisions saved.", "success");
        }
      }

      function printEhtAgenda() {
        window.print();
      }

      function saveEhtSettings() {
        showToast("EHT Settings sparade", "success");
      }

      function showEhtMeetingDetails(date) {
        showToast("Showing meeting from " + date, "info");
        // In a real system, this would show meeting details
      }

      // ==================== CASE NOTES ====================
      function addCaseNote() {
        document.getElementById("caseNoteText").value = "";
        showModal("addNoteModal");
      }

      function saveCaseNote() {
        const noteText = document.getElementById("caseNoteText").value;

        if (!noteText.trim()) {
          showToast("Ange en anteckning", "error");
          return;
        }

        const now = new Date();
        const dateStr =
          now.toLocaleDateString("sv-SE") +
          " " +
          now.toLocaleTimeString("sv-SE", {
            hour: "2-digit",
            minute: "2-digit",
          });
        const userName =
          users.find((u) => u.role === currentRole)?.name || "Du";

        const log = document.getElementById("caseNotesLog");
        const entry = document.createElement("div");
        entry.className = "note-entry";
        entry.style.cssText =
          "border-left:3px solid var(--primary);padding-left:1rem;margin-bottom:1rem;";
        entry.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <strong style="font-size:0.85rem;">${userName}</strong>
                    <span style="font-size:0.75rem;color:var(--text-light);">${dateStr}</span>
                </div>
                <p style="font-size:0.8rem;color:var(--text);margin-top:0.25rem;">${noteText}</p>
            `;
        log.insertBefore(entry, log.firstChild);

        closeModal("addNoteModal");
        showToast("Anteckning tillagd", "success");
      }

      // ==================== TOAST ====================
      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = "toast " + type;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    </script>
  </body>
</html>
